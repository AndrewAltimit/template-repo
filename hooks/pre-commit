#!/bin/bash
# Git pre-commit hook with auto-staging for formatted files

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Store the list of originally staged files
STAGED_FILES=$(git diff --cached --name-only)

# Run pre-commit hooks
echo -e "${YELLOW}Running pre-commit hooks...${NC}"
pre-commit run

# Check the exit status
RESULT=$?

if [ $RESULT -ne 0 ]; then
    # Check if files were modified (formatted)
    if ! git diff --quiet; then
        echo -e "\n${YELLOW}Files were reformatted. Auto-staging changes...${NC}"

        # Only restage files that were originally staged
        for file in $STAGED_FILES; do
            if [ -f "$file" ]; then
                git add "$file"
            fi
        done

        # Show what was staged
        echo -e "${GREEN}Auto-staged files:${NC}"
        git diff --cached --name-only

        # Run pre-commit again on the staged files
        echo -e "\n${YELLOW}Running pre-commit hooks again...${NC}"
        pre-commit run
        RESULT=$?

        if [ $RESULT -eq 0 ]; then
            echo -e "\n${GREEN}âœ… All checks passed! Commit will proceed.${NC}"
        fi
    fi
fi

exit $RESULT
