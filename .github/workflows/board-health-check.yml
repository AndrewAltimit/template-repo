---
# Health Check Workflow for Board Agent System
#
# Runs periodic health checks and generates a status badge.
# Uses the Rust board-manager CLI for all board operations.

name: Board Health Check

on:
  # Run daily at 6 AM UTC
  schedule:
    - cron: '0 6 * * *'

  # Manual trigger for on-demand checks
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable verbose output'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  issues: read

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  health-check:
    name: Board System Health
    runs-on: self-hosted
    timeout-minutes: 5

    outputs:
      status: ${{ steps.check.outputs.status }}
      board-connected: ${{ steps.check.outputs.board_connected }}
      config-valid: ${{ steps.check.outputs.config_valid }}
      agents-available: ${{ steps.check.outputs.agents_available }}
      ready-work-count: ${{ steps.check.outputs.ready_work_count }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Rust binaries
        run: |
          echo "::group::Setup Rust Binaries"

          BOARD_MANAGER="${GITHUB_WORKSPACE}/tools/rust/board-manager/target/release/board-manager"
          if [ -x "$BOARD_MANAGER" ]; then
            echo "board-manager found at $BOARD_MANAGER"
          else
            echo "Building board-manager from source..."
            cd "${GITHUB_WORKSPACE}/tools/rust/board-manager"
            cargo build --release
          fi

          mkdir -p "$HOME/.local/bin"
          ln -sf "${GITHUB_WORKSPACE}/tools/rust/board-manager/target/release/board-manager" "$HOME/.local/bin/board-manager"
          echo "PATH=$HOME/.local/bin:$PATH" >> $GITHUB_ENV

          echo "::endgroup::"

      - name: Run health checks
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_PROJECTS_TOKEN: ${{ secrets.GITHUB_PROJECTS_TOKEN }}
          BOARD_CONFIG_PATH: ai-agents-board.yml
          VERBOSE: ${{ inputs.verbose || 'false' }}
        run: |
          echo "::group::Health Checks"

          # Initialize results
          STATUS="healthy"
          BOARD_CONNECTED="false"
          CONFIG_VALID="false"
          AGENTS_AVAILABLE="[]"
          READY_WORK_COUNT="0"
          ERRORS=""

          # Check 1: Configuration file exists
          if [ -f "$BOARD_CONFIG_PATH" ]; then
            CONFIG_VALID="true"
            echo "Config file found: $BOARD_CONFIG_PATH"
          else
            CONFIG_VALID="false"
            ERRORS="Config file not found"
            STATUS="unhealthy"
          fi

          # Check 2: Board connectivity and ready work
          if [ "$CONFIG_VALID" = "true" ]; then
            READY_OUTPUT=$(board-manager --format json ready --limit 100 2>&1) || {
              echo "Board connection failed"
              BOARD_CONNECTED="false"
              STATUS="unhealthy"
              ERRORS="${ERRORS}; Board connection failed"
            }

            if echo "$READY_OUTPUT" | jq -e '.' > /dev/null 2>&1; then
              BOARD_CONNECTED="true"
              READY_WORK_COUNT=$(echo "$READY_OUTPUT" | jq 'length' 2>/dev/null || echo "0")
              echo "Board connected, found $READY_WORK_COUNT ready items"
            fi
          fi

          # Check 3: Get available agents
          if [ "$BOARD_CONNECTED" = "true" ]; then
            AGENTS_OUTPUT=$(board-manager --format json agents 2>&1) || true
            if echo "$AGENTS_OUTPUT" | jq -e '.' > /dev/null 2>&1; then
              AGENTS_AVAILABLE=$(echo "$AGENTS_OUTPUT" | jq -c '.agents // []' 2>/dev/null || echo "[]")
              echo "Available agents: $AGENTS_AVAILABLE"
            fi
          fi

          # Output results
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "board_connected=$BOARD_CONNECTED" >> $GITHUB_OUTPUT
          echo "config_valid=$CONFIG_VALID" >> $GITHUB_OUTPUT
          echo "agents_available=$AGENTS_AVAILABLE" >> $GITHUB_OUTPUT
          echo "ready_work_count=$READY_WORK_COUNT" >> $GITHUB_OUTPUT

          if [ "$VERBOSE" = "true" ]; then
            echo "=== Health Check Results ==="
            echo "Status: $STATUS"
            echo "Board Connected: $BOARD_CONNECTED"
            echo "Config Valid: $CONFIG_VALID"
            echo "Ready Work Count: $READY_WORK_COUNT"
            echo "Agents Available: $AGENTS_AVAILABLE"
            if [ -n "$ERRORS" ]; then
              echo "Errors: $ERRORS"
            fi
          fi

          echo "::endgroup::"

      - name: Generate summary
        if: always()
        env:
          STATUS: ${{ steps.check.outputs.status }}
          BOARD_CONNECTED: ${{ steps.check.outputs.board_connected }}
          CONFIG_VALID: ${{ steps.check.outputs.config_valid }}
          AGENTS_AVAILABLE: ${{ steps.check.outputs.agents_available }}
          READY_WORK_COUNT: ${{ steps.check.outputs.ready_work_count }}
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Board System Health Check

          | Check | Status |
          |-------|--------|
          | Configuration Valid | ${CONFIG_VALID:-unknown} |
          | Board Connected | ${BOARD_CONNECTED:-unknown} |
          | Ready Work Items | ${READY_WORK_COUNT:-0} |
          | Available Agents | ${AGENTS_AVAILABLE:-[]} |

          **Overall Status**: ${STATUS:-unknown}

          ---
          *Checked at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOF
