---
# Reusable workflow for AI agent work from GitHub Projects v2 board
#
# Can be triggered:
# 1. Manually via workflow_dispatch
# 2. Called by other workflows via workflow_call
#
# Usage as reusable workflow:
#   jobs:
#     agent-work:
#       uses: ./.github/workflows/board-agent-worker.yml
#       with:
#         agent-name: claude
#       secrets:
#         github-token: ${{ secrets.AGENT_TOKEN }}
#         github-projects-token: ${{ secrets.GITHUB_PROJECTS_TOKEN }}

name: Board Agent Worker

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      agent-name:
        description: 'AI agent to use'
        required: true
        type: choice
        options:
          - claude
          - opencode
          - crush
          - gemini
          - codex
        default: 'claude'
      max-issues:
        description: 'Maximum issues to process'
        required: false
        type: number
        default: 1
      dry-run:
        description: 'Query work but do not execute'
        required: false
        type: boolean
        default: false
      use-docker:
        description: 'Use Docker containers (Claude always runs on host)'
        required: false
        type: boolean
        default: false

  # Reusable workflow
  workflow_call:
    inputs:
      # Agent configuration
      agent-name:
        description: 'AI agent to use'
        required: false
        type: string
        default: 'claude'
      agent-timeout:
        description: 'Timeout for agent execution in minutes'
        required: false
        type: number
        default: 180
      job-timeout-minutes:
        description: 'Job timeout in minutes (0 = auto-calculate from agent-timeout + 20)'
        required: false
        type: number
        default: 0

      # Board configuration
      board-config-path:
        description: 'Path to board configuration file'
        required: false
        type: string
        default: 'ai-agents-board.yml'
      max-issues:
        description: 'Maximum number of issues to work on'
        required: false
        type: number
        default: 1

      # Execution modes
      dry-run:
        description: 'Query work but do not execute'
        required: false
        type: boolean
        default: false
      create-pr:
        description: 'Create PR after completing work'
        required: false
        type: boolean
        default: true

      # Label filtering
      include-labels:
        description: 'Comma-separated labels to include (only process issues with these labels)'
        required: false
        type: string
        default: ''
      exclude-labels:
        description: 'Comma-separated labels to exclude (skip issues with these labels)'
        required: false
        type: string
        default: ''

      # Observability
      json-logging:
        description: 'Enable structured JSON logging for log aggregators'
        required: false
        type: boolean
        default: false

      # Janitor settings
      stale-claim-threshold:
        description: 'Hours after which to consider a claim stale and clean it up'
        required: false
        type: number
        default: 2

      # Container configuration
      use-docker:
        description: 'Use Docker containers for agent execution'
        required: false
        type: boolean
        default: true
      docker-compose-file:
        description: 'Path to docker-compose.yml'
        required: false
        type: string
        default: 'docker-compose.yml'

      # Runner configuration
      runs-on:
        description: 'Runner label to use'
        required: false
        type: string
        default: 'self-hosted'

    secrets:
      github-token:
        description: 'GitHub token for repository operations (or uses AGENT_TOKEN)'
        required: false
      github-projects-token:
        description: 'GitHub classic token with project scope (or uses GH_PROJECTS_TOKEN)'
        required: false
      openrouter-api-key:
        description: 'OpenRouter API key for OpenCode/Crush agents (or uses OPENROUTER_API_KEY)'
        required: false
      # Alternate secret names matching repository secrets (for workflow_dispatch)
      AGENT_TOKEN:
        description: 'Repository secret for GitHub token'
        required: false
      GH_PROJECTS_TOKEN:
        description: 'Repository secret for projects token'
        required: false
      OPENROUTER_API_KEY:
        description: 'Repository secret for OpenRouter'
        required: false

    outputs:
      has-work:
        description: 'Whether work was found on the board'
        value: ${{ jobs.agent-work.outputs.has-work }}
      issue-number:
        description: 'Issue number that was worked on'
        value: ${{ jobs.agent-work.outputs.issue-number }}
      issue-title:
        description: 'Title of the issue'
        value: ${{ jobs.agent-work.outputs.issue-title }}
      work-completed:
        description: 'Whether the agent completed work'
        value: ${{ jobs.agent-work.outputs.work-completed }}
      pr-number:
        description: 'PR number if created'
        value: ${{ jobs.agent-work.outputs.pr-number }}
      pr-url:
        description: 'PR URL if created'
        value: ${{ jobs.agent-work.outputs.pr-url }}
      branch-name:
        description: 'Branch name created for work'
        value: ${{ jobs.agent-work.outputs.branch-name }}
      summary-json:
        description: 'JSON summary of work performed'
        value: ${{ jobs.agent-work.outputs.summary-json }}
      stale-claims-cleaned:
        description: 'Number of stale claims cleaned up'
        value: ${{ jobs.agent-work.outputs.stale-claims-cleaned }}

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: board-agent-${{ inputs.agent-name || github.event.inputs.agent-name || 'claude' }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  agent-work:
    name: '${{ inputs.agent-name || github.event.inputs.agent-name || ''claude'' }} Agent Work'
    runs-on: ${{ inputs.runs-on || 'self-hosted' }}
    # Job timeout: use explicit input if > 0, otherwise auto-calculate from agent-timeout + 20
    timeout-minutes: ${{ inputs.job-timeout-minutes > 0 && inputs.job-timeout-minutes || fromJSON(inputs.agent-timeout || 180) + 20 }}


    outputs:
      has-work: ${{ steps.work.outputs.has-work }}
      issue-number: ${{ steps.work.outputs.issue-number }}
      issue-title: ${{ steps.work.outputs.issue-title }}
      work-completed: ${{ steps.work.outputs.work-completed }}
      pr-number: ${{ steps.work.outputs.pr-number }}
      pr-url: ${{ steps.work.outputs.pr-url }}
      branch-name: ${{ steps.work.outputs.branch-name }}
      summary-json: ${{ steps.work.outputs.summary-json }}
      stale-claims-cleaned: ${{ steps.work.outputs.stale-claims-cleaned }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          # Use workflow_call secret or fall back to repository secret for workflow_dispatch
          token: ${{ secrets.github-token || secrets.AGENT_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "AI Agent Bot"
          git config --global user.email "ai-agent@localhost"

      - name: Initialize output directories
        run: |
          # Pre-create output directories with correct ownership to prevent
          # Docker from creating them as root (causes permission errors on cleanup)
          if [ -f "./automation/setup/docker/init-output-dirs.sh" ]; then
            bash ./automation/setup/docker/init-output-dirs.sh
          fi

      - name: Execute board agent work
        id: work
        uses: ./.github/actions/board-agent-work
        with:
          # Secrets: workflow_call || repository secrets
          github-token: ${{ secrets.github-token || secrets.AGENT_TOKEN }}
          github-projects-token: ${{ secrets.github-projects-token || secrets.GH_PROJECTS_TOKEN }}
          # Inputs: workflow_call || workflow_dispatch || defaults
          agent-name: ${{ inputs.agent-name || github.event.inputs.agent-name || 'claude' }}
          agent-timeout: ${{ inputs.agent-timeout || 180 }}
          board-config-path: ${{ inputs.board-config-path || 'ai-agents-board.yml' }}
          max-issues: ${{ inputs.max-issues || github.event.inputs.max-issues || 1 }}
          include-labels: ${{ inputs.include-labels || '' }}
          exclude-labels: ${{ inputs.exclude-labels || '' }}
          dry-run: ${{ inputs.dry-run || github.event.inputs.dry-run || false }}
          create-pr: ${{ inputs.create-pr != false }}
          json-logging: ${{ inputs.json-logging || false }}
          stale-claim-threshold: ${{ inputs.stale-claim-threshold || 2 }}
          use-docker: ${{ inputs.use-docker || github.event.inputs.use-docker || false }}
          docker-compose-file: ${{ inputs.docker-compose-file || 'docker-compose.yml' }}
          openrouter-api-key: ${{ secrets.openrouter-api-key || secrets.OPENROUTER_API_KEY }}

      - name: Report results
        if: always()
        run: |
          # The composite action generates a comprehensive Step Summary
          # This step just logs the JSON summary for downstream consumption
          echo "JSON Summary:"
          echo '${{ steps.work.outputs.summary-json }}' | jq . 2>/dev/null || echo '${{ steps.work.outputs.summary-json }}'

      - name: Fix output directory permissions
        if: always()
        run: |
          # Fix ownership of any files created by Docker containers to prevent
          # permission errors on next checkout cleanup
          if [ -d "outputs" ]; then
            # Use Docker to recursively chown since it can access root-owned files
            docker run --rm -v "$(pwd)/outputs:/outputs" alpine:latest \
              chown -R "$(id -u):$(id -g)" /outputs 2>/dev/null || true
          fi
