---
name: Main CI
# Comprehensive CI for main branch with all validation stages

'on':
  push:
    branches: [main]
    tags:
      - 'v*'  # Trigger on version tags (e.g., v1.0.0, v2.1.3)
  workflow_dispatch:
    inputs:
      skip_docker_push:
        description: 'Skip pushing Docker images'
        required: false
        type: boolean
        default: false
      create_release:
        description: 'Create a release (even without tag)'
        required: false
        type: boolean
        default: false

concurrency:
  group: main-ci-${{ github.sha }}
  cancel-in-progress: false  # Don't cancel main branch builds

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Stage 1: Format check
  format-check:
    uses: ./.github/workflows/lint-stages.yml
    with:
      stage: format
      upload_artifacts: true

  # Stage 2: Basic linting
  basic-lint:
    needs: format-check
    uses: ./.github/workflows/lint-stages.yml
    with:
      stage: basic
      upload_artifacts: true

  # Stage 3: Full analysis
  full-lint:
    needs: basic-lint
    uses: ./.github/workflows/lint-stages.yml
    with:
      stage: full
      upload_artifacts: true

  # Stage 4: Test suite execution
  test-suite:
    name: Test Suite
    needs: basic-lint
    runs-on: self-hosted
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          clean: true
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}
          lfs: true

      - name: Post-checkout setup
        run: |
          # Initialize output directories to prevent root ownership issues
          if [ -f "./automation/setup/docker/init-output-dirs.sh" ]; then
            ./automation/setup/docker/init-output-dirs.sh
          fi

      - name: Run tests
        env:
          MCP_GAEA2_URL: http://192.168.0.152:8007
        run: |
          echo "ðŸ§ª Running test suite..."
          ./automation/ci-cd/run-ci.sh test --cov-report=html --timeout=300 --junitxml=test-results.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            test-results.xml
            htmlcov/
            coverage.xml
          retention-days: 30

      - name: Generate test summary
        if: always()
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f test-results.xml ]; then
            # Parse test results
            python3 -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('test-results.xml')
          root = tree.getroot()
          tests = int(root.attrib.get('tests', 0))
          failures = int(root.attrib.get('failures', 0))
          errors = int(root.attrib.get('errors', 0))
          skipped = int(root.attrib.get('skipped', 0))
          time = float(root.attrib.get('time', 0))

          print(f'| Metric | Value |')
          print(f'|--------|-------|')
          print(f'| Total Tests | {tests} |')
          print(f'| Passed | {tests - failures - errors - skipped} |')
          print(f'| Failed | {failures} |')
          print(f'| Errors | {errors} |')
          print(f'| Skipped | {skipped} |')
          print(f'| Duration | {time:.2f}s |')
          " >> $GITHUB_STEP_SUMMARY
          fi

          # Add coverage info if available
          if [ -f coverage.xml ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Coverage Report" >> $GITHUB_STEP_SUMMARY
            python3 -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('coverage.xml')
          root = tree.getroot()
          line_rate = float(root.attrib.get('line-rate', 0)) * 100
          branch_rate = float(root.attrib.get('branch-rate', 0)) * 100

          print(f'- Line Coverage: {line_rate:.1f}%')
          print(f'- Branch Coverage: {branch_rate:.1f}%')
          " >> $GITHUB_STEP_SUMMARY
          fi

  # Stage 5: MCP servers validation
  mcp-validation:
    name: MCP Servers Validation
    needs: basic-lint
    runs-on: self-hosted
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Test modular MCP servers with Docker
        run: |
          echo "ðŸ¤– Testing modular MCP server functionality..."

          # Build the CI image if needed
          docker-compose build python-ci

          # Test Code Quality MCP server
          docker-compose run --rm python-ci bash -c "
          pip install -r config/python/requirements.txt && python3 -c '
          import sys
          sys.path.insert(0, \".\")
          sys.path.append(\"tools/mcp\")  # Add MCP packages to path

          # Test Code Quality server
          try:
              from mcp_code_quality.server import CodeQualityMCPServer
              from mcp_code_quality.tools import TOOLS as CODE_TOOLS
              print(\"âœ… Code Quality MCP server imported successfully\")
              print(f\"  - {len(CODE_TOOLS)} tools available\")
              for tool in CODE_TOOLS:
                  print(f\"    - {tool}\")
          except ImportError as e:
              print(f\"âŒ Failed to import Code Quality server: {e}\")
              exit(1)

          # Test Content Creation server
          try:
              from mcp_content_creation.server import ContentCreationMCPServer
              from mcp_content_creation.tools import TOOLS as CONTENT_TOOLS
              print(\"âœ… Content Creation MCP server imported successfully\")
              print(f\"  - {len(CONTENT_TOOLS)} tools available\")
              for tool in CONTENT_TOOLS:
                  print(f\"    - {tool}\")
          except ImportError as e:
              print(f\"âŒ Failed to import Content Creation server: {e}\")
              exit(1)

          # Test Gaea2 server (stubs only in container)
          try:
              from mcp_gaea2.server import Gaea2MCPServer
              from mcp_gaea2.tools import TOOLS as GAEA2_TOOLS
              print(\"âœ… Gaea2 MCP server imported successfully\")
              print(f\"  - {len(GAEA2_TOOLS)} tools available\")
          except ImportError as e:
              print(f\"âŒ Failed to import Gaea2 server: {e}\")
              exit(1)

          # Test OpenCode server
          try:
              from mcp_opencode.server import OpenCodeMCPServer
              from mcp_opencode.tools import TOOLS as OPENCODE_TOOLS
              print(\"âœ… OpenCode MCP server imported successfully\")
              print(f\"  - {len(OPENCODE_TOOLS)} tools available\")
              for tool in OPENCODE_TOOLS:
                  print(f\"    - {tool}\")
          except ImportError as e:
              print(f\"âŒ Failed to import OpenCode server: {e}\")
              exit(1)

          # Test Crush server
          try:
              from mcp_crush.server import CrushMCPServer
              from mcp_crush.tools import TOOLS as CRUSH_TOOLS
              print(\"âœ… Crush MCP server imported successfully\")
              print(f\"  - {len(CRUSH_TOOLS)} tools available\")
              for tool in CRUSH_TOOLS:
                  print(f\"    - {tool}\")
          except ImportError as e:
              print(f\"âŒ Failed to import Crush server: {e}\")
              exit(1)
          '
          "

      - name: Start Code Quality MCP server
        if: always()
        uses: ./.github/actions/docker-compose-health-check
        with:
          services: 'mcp-code-quality'
          health-endpoint: 'http://localhost:8010/health'
          timeout: '30'
          build: 'true'

      - name: Start Content Creation MCP server
        if: always()
        uses: ./.github/actions/docker-compose-health-check
        with:
          services: 'mcp-content-creation'
          health-endpoint: 'http://localhost:8011/health'
          timeout: '30'
          build: 'true'

      - name: Test MCP servers HTTP endpoints
        if: always()
        run: |
          echo "ðŸŒ Testing MCP servers HTTP endpoints..."
          # Test Code Quality server
          curl -s http://localhost:8010/health || echo "Code Quality health check failed"
          curl -s http://localhost:8010/mcp/tools || echo "Code Quality tools listing failed"

          # Test Content Creation server
          curl -s http://localhost:8011/health || echo "Content Creation health check failed"
          curl -s http://localhost:8011/mcp/tools || echo "Content Creation tools listing failed"

      - name: Stop MCP servers
        if: always()
        run: |
          docker-compose down
          # Clean up output directories using Docker to handle permissions
          ./automation/ci-cd/cleanup-outputs.sh

  # Stage 6: Documentation build
  docs-build:
    name: Documentation Build
    needs: basic-lint
    runs-on: self-hosted
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Validate documentation
        run: |
          echo "ðŸ“š Validating documentation..."

          # Check for required documentation files
          required_docs=(
            "README.md"
            "config/python/requirements.txt"
          )

          for doc in "${required_docs[@]}"; do
            if [ -f "$doc" ]; then
              echo "âœ… Found: $doc"
            else
              echo "âŒ Missing: $doc"
              exit 1
            fi
          done

          # Check markdown files for basic issues
          find . -name "*.md" -type f | while read -r file; do
            echo "Checking: $file"
            # Check for broken relative links
            grep -Eo '\[([^]]+)\]\(([^)]+)\)' "$file" | grep -v http | while read -r link; do
              path=$(echo "$link" | sed -E 's/.*\]\(([^)]+)\).*/\1/')
              if [[ ! -f "$path" && ! -d "$path" && "$path" != "#"* ]]; then
                echo "  âš ï¸  Possible broken link: $path"
              fi
            done
          done

  # Stage 7: sleeper agents Tests
  sleeper-agents-tests:
    name: sleeper agents Tests
    needs: test-suite
    uses: ./.github/workflows/sleeper-agents-tests.yml
    secrets: inherit

  # Stage 8: Security scanning
  security-scan:
    name: Security Scanning
    needs: basic-lint
    runs-on: self-hosted
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run security scans
        run: |
          echo "ðŸ”’ Running security scans..."
          ./automation/ci-cd/run-ci.sh security

          # Display summary
          if [ -f bandit-report.json ]; then
            docker-compose run --rm python-ci python3 -c "
          import json
          with open('bandit-report.json') as f:
              data = json.load(f)
          metrics = data.get('metrics', {})
          results = data.get('results', [])

          print('### Bandit Security Scan Results')
          print(f'Total issues: {len(results)}')
          for severity in ['HIGH', 'MEDIUM', 'LOW']:
              count = sum(1 for r in results if r['issue_severity'] == severity)
              if count > 0:
                  print(f'- {severity}: {count}')
          " >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check dependency vulnerabilities
        run: |
          echo "ðŸ” Checking dependency vulnerabilities..."
          # Security scan already includes safety check

          if [ -f safety-report.json ] && [ -s safety-report.json ]; then
            echo "### Dependency Vulnerabilities" >> $GITHUB_STEP_SUMMARY
            docker-compose run --rm python-ci python3 -c "
          import json
          with open('safety-report.json') as f:
              vulns = json.load(f)
          if vulns:
              print(f'Found {len(vulns)} vulnerable dependencies')
          else:
              print('âœ… No known vulnerabilities found')
          " >> $GITHUB_STEP_SUMMARY
          fi

          # Run pip-audit
          docker-compose run --rm python-ci bash -c "pip install -r config/python/requirements.txt && pip-audit --desc || true"

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            bandit-report.json
            safety-report.json
          retention-days: 30

  # Stage 9: Build Docker images using docker-compose
  build-images:
    name: Build Docker Images
    needs: [format-check, basic-lint, full-lint, test-suite, mcp-validation]
    runs-on: self-hosted
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      # Use docker-compose to build all images with proper dependency handling
      # This resolves multi-stage build issues by building in dependency order
      - name: Build all Docker images with docker-compose
        env:
          GITHUB_SHA: ${{ github.sha }}
        run: |
          echo "ðŸ³ Building Docker images using docker-compose..."
          echo "This handles multi-stage dependencies automatically."

          # Build all images in dependency order using dedicated script
          ./automation/ci-cd/build-docker-images.sh

      - name: Test Docker Compose with health check
        uses: ./.github/actions/docker-compose-health-check
        with:
          services: 'mcp-code-quality mcp-content-creation'  # Test main MCP services
          health-endpoint: 'http://localhost:8010/health'
          timeout: '60'
          build: 'false'  # Images already built above

      - name: Stop services
        if: always()
        run: |
          docker-compose down
          # Clean up output directories using Docker to handle permissions
          ./automation/ci-cd/cleanup-outputs.sh

  # Stage 10: Integration tests
  integration-tests:
    name: Integration Tests
    needs: build-images
    if: success()
    runs-on: self-hosted
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Compose
        run: |
          docker-compose version

      - name: Start services for integration tests
        uses: ./.github/actions/docker-compose-health-check
        with:
          services: 'mcp-code-quality mcp-content-creation'  # Test main MCP services
          health-endpoint: 'http://localhost:8010/health'
          timeout: '60'
          build: 'true'

      - name: Run integration test suite
        run: |
          echo "ðŸ§ª Running integration tests..."
          # Run integration test suite if available
          if [ -f "tests/integration_test.py" ]; then
            docker-compose exec -T python-ci pytest tests/integration_test.py -v
          fi

      - name: Clean up services
        if: always()
        run: |
          docker-compose down
          # Clean up output directories using Docker to handle permissions
          ./automation/ci-cd/cleanup-outputs.sh

  # Stage 11: Deploy (placeholder)
  deploy:
    name: Deploy to Production
    needs: [build-images, integration-tests, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: self-hosted
    environment: production
    steps:
      - name: Deploy application
        run: |
          echo "ðŸš€ Deploying ${{ github.sha }} to production..."
          echo "Note: Add actual deployment steps here"
          echo ""
          echo "Deployment checklist:"
          echo "- [ ] Update production configuration"
          echo "- [ ] Run database migrations"
          echo "- [ ] Update container orchestration"
          echo "- [ ] Verify health checks"
          echo "- [ ] Monitor error rates"

  # Stage 12: Build Python wheels for release
  build-python-wheels:
    name: Build Python Wheels
    needs: [test-suite, security-scan]
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.create_release == 'true'
    runs-on: self-hosted
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          clean: true

      - name: Build all package wheels
        run: |
          echo "ðŸ“¦ Building Python wheels for all packages..."
          mkdir -p dist

          # Build github-agents wheel
          echo "Building github-agents..."
          docker-compose run --rm python-ci bash -c "
            cd packages/github_agents && \
            pip install build && \
            python -m build --wheel --outdir /app/dist
          "

          # Build economic-agents wheel
          echo "Building economic-agents..."
          docker-compose run --rm python-ci bash -c "
            cd packages/economic_agents && \
            pip install build && \
            python -m build --wheel --outdir /app/dist
          "

          # Build sleeper-agents wheel
          echo "Building sleeper-agents..."
          docker-compose run --rm python-ci bash -c "
            cd packages/sleeper_agents && \
            pip install build && \
            python -m build --wheel --outdir /app/dist
          "

          echo "Built wheels:"
          ls -la dist/*.whl

      - name: Upload wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-wheels
          path: dist/*.whl
          retention-days: 90

  # Stage 13: Build LaTeX documentation for release
  build-latex-docs:
    name: Build LaTeX Documentation
    needs: [test-suite]
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.create_release == 'true'
    runs-on: self-hosted
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
          clean: true

      - name: Create output directory
        run: mkdir -p docs_output

      - name: Build Sleeper Agents Framework Guide
        run: |
          echo "Building Sleeper_Agents_Framework_Guide.pdf..."
          docker run --rm \
            --user "$(id -u):$(id -g)" \
            -v "$(pwd)/packages/sleeper_agents/docs:/data" \
            -v "$(pwd)/docs_output:/output" \
            texlive/texlive:TL2024-historic \
            bash -c "cd /data && latexmk -pdf -interaction=nonstopmode -output-directory=/output Sleeper_Agents_Framework_Guide.tex"
          # Rename to sensible kebab-case filename
          mv docs_output/Sleeper_Agents_Framework_Guide.pdf docs_output/sleeper-agents-framework-guide.pdf

      - name: Build AgentCore Memory Integration Guide
        run: |
          echo "Building AgentCore_Memory_Integration_Guide.pdf..."
          docker run --rm \
            --user "$(id -u):$(id -g)" \
            -v "$(pwd)/docs/integrations/ai-services:/data" \
            -v "$(pwd)/docs_output:/output" \
            texlive/texlive:TL2024-historic \
            bash -c "cd /data && latexmk -pdf -interaction=nonstopmode -output-directory=/output AgentCore_Memory_Integration_Guide.tex"
          # Rename to sensible kebab-case filename
          mv docs_output/AgentCore_Memory_Integration_Guide.pdf docs_output/agentcore-memory-integration-guide.pdf

      - name: Build Virtual Character System Guide
        run: |
          echo "Building Virtual_Character_System_Guide.pdf..."
          docker run --rm \
            --user "$(id -u):$(id -g)" \
            -v "$(pwd)/docs/integrations/ai-services:/data" \
            -v "$(pwd)/docs_output:/output" \
            texlive/texlive:TL2024-historic \
            bash -c "cd /data && latexmk -pdf -interaction=nonstopmode -output-directory=/output Virtual_Character_System_Guide.tex"
          # Rename to sensible kebab-case filename
          mv docs_output/Virtual_Character_System_Guide.pdf docs_output/virtual-character-system-guide.pdf

      - name: Build AI Agents Political Targeting Report
        run: |
          ./automation/ci-cd/build-latex-doc.sh ai-agents-political-targeting.tex
          # Rename to include -report suffix for consistency
          mv docs_output/ai-agents-political-targeting.pdf docs_output/ai-agents-political-targeting-report.pdf

      - name: Build AI Agents WMD Proliferation Report
        run: |
          ./automation/ci-cd/build-latex-doc.sh ai-agents-wmd-proliferation.tex
          # Rename to include -report suffix for consistency
          mv docs_output/ai-agents-wmd-proliferation.pdf docs_output/ai-agents-wmd-proliferation-report.pdf

      - name: Build AI Agents Economic Actors Report
        run: |
          ./automation/ci-cd/build-latex-doc.sh ai-agents-economic-actors.tex
          # Rename to include -report suffix for consistency
          mv docs_output/ai-agents-economic-actors.pdf docs_output/ai-agents-economic-actors-report.pdf

      - name: List built PDFs
        run: |
          echo "Built PDFs:"
          ls -la docs_output/*.pdf

      - name: Upload PDF artifacts
        uses: actions/upload-artifact@v4
        with:
          name: documentation-pdfs
          path: docs_output/*.pdf
          retention-days: 90

      - name: Cleanup auxiliary files
        if: always()
        run: |
          rm -rf docs_output/*.aux docs_output/*.log docs_output/*.toc \
                 docs_output/*.out docs_output/*.fls docs_output/*.fdb_latexmk \
                 2>/dev/null || true

  # Stage 14: Create GitHub Release
  create-release:
    name: Create GitHub Release
    needs: [build-python-wheels, build-latex-docs, build-images, integration-tests]
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.create_release == 'true'
    runs-on: self-hosted
    timeout-minutes: 10
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download wheel artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-wheels
          path: release-artifacts/wheels

      - name: Download PDF artifacts
        uses: actions/download-artifact@v4
        with:
          name: documentation-pdfs
          path: release-artifacts/docs

      - name: List release artifacts
        run: |
          echo "Release artifacts:"
          find release-artifacts -type f | sort

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="v$(date +%Y.%m.%d)-$(echo ${{ github.sha }} | cut -c1-7)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Generate release notes
        id: release_notes
        run: |
          cat << 'EOF' > release_notes.md
          ## Release ${{ steps.version.outputs.version }}

          ### Python Packages

          This release includes wheels for the following Python packages:

          | Package | Description |
          |---------|-------------|
          | `github-agents` | Automated agents for GitHub workflows |
          | `economic-agents` | Autonomous economic agent simulation framework |
          | `sleeper-agents` | Framework for creating and studying sleeper agents |

          ### Documentation

          PDF documentation included in this release:

          - **Sleeper Agents Framework Guide** - Comprehensive guide to the sleeper agents detection framework
          - **AgentCore Memory Integration Guide** - AWS Bedrock AgentCore memory integration documentation
          - **Virtual Character System Guide** - AI agent embodiment and multimedia performance platform guide
          - **AI Agents Political Targeting Report** - Risk assessment for AI agents in political targeting
          - **AI Agents WMD Proliferation Report** - Risk assessment for AI agents in WMD proliferation
          - **AI Agents Economic Actors Report** - Risk assessment for AI agents as autonomous economic actors

          ### Installation

          ```bash
          # Install packages from wheels
          pip install github_agents-*.whl
          pip install economic_agents-*.whl
          pip install sleeper_agents-*.whl
          ```

          ### Commit Information

          - **Commit**: ${{ github.sha }}
          - **Branch**: ${{ github.ref_name }}
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          files: |
            release-artifacts/wheels/*.whl
            release-artifacts/docs/*.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Final status notification
  notify:
    name: CI Summary
    needs: [
      format-check, basic-lint, full-lint, test-suite,
      mcp-validation, docs-build, sleeper-agents-tests,
      security-scan, build-images, integration-tests, deploy,
      build-python-wheels, build-latex-docs, create-release
    ]
    if: always()
    runs-on: self-hosted
    steps:
      - name: Generate CI Summary
        run: |
          echo "# ðŸ“Š CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format Check | ${{ needs.format-check.result == 'success' && 'âœ…' || needs.format-check.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Basic Lint | ${{ needs.basic-lint.result == 'success' && 'âœ…' || needs.basic-lint.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Full Lint | ${{ needs.full-lint.result == 'success' && 'âœ…' || needs.full-lint.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | ${{ needs.test-suite.result == 'success' && 'âœ…' || needs.test-suite.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| MCP Validation | ${{ needs.mcp-validation.result == 'success' && 'âœ…' || needs.mcp-validation.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| sleeper agents | ${{ needs.sleeper-agents-tests.result == 'success' && 'âœ…' || needs.sleeper-agents-tests.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.docs-build.result == 'success' && 'âœ…' || needs.docs-build.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ…' || needs.security-scan.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.build-images.result == 'success' && 'âœ…' || needs.build-images.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result == 'success' && 'âœ…' || needs.integration-tests.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result == 'success' && 'âœ…' || needs.deploy.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Wheels | ${{ needs.build-python-wheels.result == 'success' && 'âœ…' || needs.build-python-wheels.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| LaTeX Docs | ${{ needs.build-latex-docs.result == 'success' && 'âœ…' || needs.build-latex-docs.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Release | ${{ needs.create-release.result == 'success' && 'âœ…' || needs.create-release.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "## âŒ CI Pipeline Failed" >> $GITHUB_STEP_SUMMARY
            echo "One or more stages failed. Please review the logs." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… CI Pipeline Succeeded" >> $GITHUB_STEP_SUMMARY
            echo "All stages completed successfully!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create issue on failure
        if: failure() && github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            const failed = [];
            const needs = ${{ toJSON(needs) }};

            for (const [job, data] of Object.entries(needs)) {
              if (data.result === 'failure') {
                failed.push(job);
              }
            }

            if (failed.length > 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš¨ Main CI Failed: ${failed.join(', ')}`,
                body: `## CI Failure Report

                **Commit**: ${context.sha}
                **Run**: [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
                **Failed Jobs**: ${failed.join(', ')}

                Please investigate and fix the issues.`,
                labels: ['ci-failure', 'automated']
              });
            }
