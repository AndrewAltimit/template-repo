---
name: Gaea2 MCP Integration Tests

on:
  workflow_call:
    inputs:
      server_url:
        description: 'Gaea2 MCP Server URL'
        required: false
        default: 'http://localhost:8007'
        type: string
  workflow_dispatch:
    inputs:
      server_url:
        description: 'Gaea2 MCP Server URL'
        required: false
        default: 'http://localhost:8007'

# Enable BuildKit for docker compose builds (required for --mount syntax in Dockerfiles)
env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  check-server-availability:
    name: Check Gaea2 Server Availability
    runs-on: self-hosted
    timeout-minutes: 2
    outputs:
      server_available: ${{ steps.check.outputs.available }}
    steps:
      - name: Check if Gaea2 MCP server is reachable
        id: check
        run: |
          SERVER_URL="${{ inputs.server_url || 'http://localhost:8007' }}"
          echo "Checking Gaea2 MCP server availability at: $SERVER_URL"

          # Try to connect to the server with a 5 second timeout
          if curl -f -s --connect-timeout 5 --max-time 10 "${SERVER_URL}/health" > /dev/null 2>&1; then
            echo "Gaea2 MCP server is available at $SERVER_URL"
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "Gaea2 MCP server is not reachable at $SERVER_URL"
            echo "Tests will be skipped"
            echo "available=false" >> $GITHUB_OUTPUT
          fi

  gaea2-integration-tests:
    name: Gaea2 MCP Server Integration Tests
    needs: check-server-availability
    if: needs.check-server-availability.outputs.server_available == 'true'
    runs-on: self-hosted
    timeout-minutes: 10
    env:
      GAEA2_MCP_URL: ${{ inputs.server_url || 'http://localhost:8007' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
          clean: true

      - name: Test MCP server health endpoint
        run: |
          echo "Testing Gaea2 MCP server health..."
          curl -f -s "${{ env.GAEA2_MCP_URL }}/health" | jq . || echo "Health check response received"

      - name: Test MCP tools listing
        run: |
          echo "Testing MCP tools listing..."
          curl -f -s "${{ env.GAEA2_MCP_URL }}/mcp/tools" | jq . || echo "Tools listing response received"

      - name: Test create_gaea2_project tool
        id: test-create-project
        run: |
          echo "Testing create_gaea2_project tool..."
          RESPONSE=$(curl -s -X POST "${{ env.GAEA2_MCP_URL }}/mcp/call" \
            -H "Content-Type: application/json" \
            -d '{
              "tool": "create_gaea2_project",
              "arguments": {
                "project_name": "ci_test_project",
                "nodes": [
                  {"id": 100, "type": "Mountain", "name": "Mountain"},
                  {"id": 101, "type": "Output", "name": "Output"}
                ],
                "connections": [
                  {"from_node": 100, "to_node": 101}
                ]
              }
            }')
          echo "Response: $RESPONSE"
          echo "$RESPONSE" | jq -e '.content' && echo "Create project succeeded"

      - name: Test list_gaea2_templates tool
        run: |
          echo "Testing list_gaea2_templates tool..."
          curl -s -X POST "${{ env.GAEA2_MCP_URL }}/mcp/call" \
            -H "Content-Type: application/json" \
            -d '{
              "tool": "list_gaea2_templates",
              "arguments": {}
            }' | jq .

      - name: Test validate_and_fix_workflow tool
        run: |
          echo "Testing validate_and_fix_workflow tool..."
          curl -s -X POST "${{ env.GAEA2_MCP_URL }}/mcp/call" \
            -H "Content-Type: application/json" \
            -d '{
              "tool": "validate_and_fix_workflow",
              "arguments": {
                "nodes": [
                  {"id": 1, "type": "Mountain", "name": ""},
                  {"id": 2, "type": "Output", "name": "Output"}
                ],
                "connections": [
                  {"from_node": 1, "to_node": 2}
                ],
                "strict_mode": false
              }
            }' | jq .

      - name: Generate Test Summary
        if: always()
        run: |
          echo "## Gaea2 MCP Integration Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tools Listing | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Create Project | ${{ steps.test-create-project.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Server URL**: ${{ env.GAEA2_MCP_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Server Type**: Rust MCP Server" >> $GITHUB_STEP_SUMMARY
