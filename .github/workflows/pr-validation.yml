---
name: Pull Request Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, converted_to_draft]
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (for draft PRs)'
        required: false
        type: boolean
        default: false
      force_docker_validation:
        description: 'Force container validation'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  issues: write
  packages: read

concurrency:
  group: pr-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # Fork guard: block fork PRs from running on self-hosted runners with write perms.
  # Fork PRs could execute arbitrary code on the runner. This job gates all others.
  fork-guard:
    name: Fork PR Guard
    runs-on: ubuntu-latest
    if: >-
      github.event_name != 'pull_request' ||
      github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - run: echo "Not a fork PR - proceeding"

  # Stage 1: Quick validation and change detection
  detect-changes:
    name: Change Detection & Quick Validation
    needs: fork-guard
    runs-on: self-hosted
    timeout-minutes: 5
    outputs:
      python_changed: ${{ steps.changes.outputs.python_changed }}
      yaml_changed: ${{ steps.changes.outputs.yaml_changed }}
      docker_changed: ${{ steps.changes.outputs.docker_changed }}
      mcp_changed: ${{ steps.changes.outputs.mcp_changed }}
      docs_changed: ${{ steps.changes.outputs.docs_changed }}
      sleeper_changed: ${{ steps.changes.outputs.sleeper_changed }}
      dashboard_changed: ${{ steps.changes.outputs.dashboard_changed }}
      ci_changed: ${{ steps.changes.outputs.ci_changed }}
      injection_toolkit_changed: ${{ steps.changes.outputs.injection_toolkit_changed }}
      economic_agents_changed: ${{ steps.changes.outputs.economic_agents_changed }}
      rust_tools_changed: ${{ steps.changes.outputs.rust_tools_changed }}
      workflow_files_changed: ${{ steps.changes.outputs.workflow_files_changed }}
      github_board_changed: ${{ steps.changes.outputs.github_board_changed }}
      files_changed: ${{ steps.changes.outputs.files_changed }}
      tex_changed: ${{ steps.changes.outputs.tex_changed }}
      # Docker image-specific change detection
      docker_code_quality_changed: ${{ steps.changes.outputs.docker_code_quality_changed }}
      docker_content_changed: ${{ steps.changes.outputs.docker_content_changed }}
      docker_gaea2_changed: ${{ steps.changes.outputs.docker_gaea2_changed }}
      docker_http_bridge_changed: ${{ steps.changes.outputs.docker_http_bridge_changed }}
      docker_python_ci_changed: ${{ steps.changes.outputs.docker_python_ci_changed }}
    steps:
      - name: Pre-checkout cleanup
        run: |
          if [ -d "outputs" ] || [ -d "evaluation_results" ] || [ -f ".git/index.lock" ]; then
            docker run --rm -v "$(pwd):/workspace" busybox:1.36.1 sh -c \
              "rm -rf /workspace/outputs /workspace/evaluation_results /workspace/.git/index.lock" || \
              sudo rm -rf outputs evaluation_results .git/index.lock 2>/dev/null || true
          fi

      - name: Clean up stale Docker networks
        run: |
          # Remove orphaned CI networks from previous runs to prevent
          # "all predefined address pools have been fully subnetted" errors
          stale_networks=$(docker network ls --filter "name=ci-" --format "{{.Name}}" || true)
          if [ -n "$stale_networks" ]; then
            stale_count=$(echo "$stale_networks" | wc -l)
            echo "Removing $stale_count stale CI network(s)..."
            echo "$stale_networks" | xargs -r docker network rm 2>/dev/null || true
          else
            echo "No stale CI networks found"
          fi

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          clean: true
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}
          lfs: true

      - name: Post-checkout setup
        run: |
          if [ -f "./automation/setup/docker/init-output-dirs.sh" ]; then
            ./automation/setup/docker/init-output-dirs.sh
          fi

      - name: Detect file changes
        id: changes
        run: |
          echo "Analyzing changes..."

          # Handle different trigger types
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "PR trigger - comparing with base branch: ${{ github.base_ref }}"
            git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt
          elif [ "${{ github.event_name }}" = "push" ]; then
            echo "Push trigger - comparing with previous commit"
            git diff --name-only HEAD~1..HEAD > changed_files.txt
          else
            echo "Manual trigger - comparing with main branch"
            git diff --name-only origin/main...HEAD > changed_files.txt || git diff --name-only HEAD~5..HEAD > changed_files.txt
          fi

          # Count different types of changes
          python_count=$(grep -E '\.(py)$' changed_files.txt | wc -l || echo "0")
          yaml_count=$(grep -E '\.(ya?ml|json)$' changed_files.txt | wc -l || echo "0")
          docker_count=$(grep -E '(Dockerfile|docker-compose\.yml|docker-compose\.yaml|\.dockerignore)' changed_files.txt | wc -l || echo "0")
          mcp_count=$(grep -E '(mcp|MCP|tools/)' changed_files.txt | wc -l || echo "0")
          docs_count=$(grep -E '\.(md|rst|txt)$' changed_files.txt | wc -l || echo "0")
          sleeper_count=$(grep -E '(packages/sleeper_agents|sleeper-evaluation)' changed_files.txt | wc -l || echo "0")
          dashboard_count=$(grep -E '(packages/sleeper_agents/dashboard)' changed_files.txt | wc -l || echo "0")
          ci_count=$(grep -E '(automation/ci-cd|\.github/workflows|docker/)' changed_files.txt | wc -l || echo "0")
          injection_toolkit_count=$(grep -E 'packages/injection_toolkit' changed_files.txt | wc -l || echo "0")
          economic_agents_count=$(grep -E 'packages/economic_agents' changed_files.txt | wc -l || echo "0")
          RUST_TOOLS_PATTERN='tools/rust/|tools/mcp/mcp_gemini|tools/mcp/mcp_github_board'
          RUST_TOOLS_PATTERN="$RUST_TOOLS_PATTERN|tools/mcp/mcp_elevenlabs_speech|tools/mcp/mcp_agentcore_memory"
          RUST_TOOLS_PATTERN="$RUST_TOOLS_PATTERN|tools/mcp/mcp_desktop_control|tools/mcp/mcp_blender|tools/mcp/mcp_comfyui|tools/mcp/mcp_ai_toolkit"
          RUST_TOOLS_PATTERN="$RUST_TOOLS_PATTERN|tools/mcp/mcp_video_editor|tools/mcp/mcp_virtual_character|tools/mcp/mcp_gaea2|tools/mcp/mcp_memory_explorer"
          rust_tools_count=$(grep -E "$RUST_TOOLS_PATTERN" changed_files.txt | wc -l || echo "0")
          workflow_files_count=$(grep -E '\.github/workflows/' changed_files.txt | wc -l || echo "0")
          BOARD_PATTERN='tools/rust/board-manager|tools/mcp/mcp_github_board'
          BOARD_PATTERN="$BOARD_PATTERN|docker/mcp-github-board\\.Dockerfile"
          BOARD_PATTERN="$BOARD_PATTERN|docker/requirements/requirements-github-board\\.txt"
          github_board_count=$(grep -E "$BOARD_PATTERN" changed_files.txt | wc -l || echo "0")
          TEX_PATTERN='\.tex$|automation/ci-cd/build-latex-doc\.sh|docker/texlive\.Dockerfile|\.github/workflows/build-docs\.yml'
          tex_count=$(grep -E "$TEX_PATTERN" changed_files.txt | wc -l || echo "0")
          total_files=$(cat changed_files.txt | wc -l)

          # Docker image-specific change detection
          # Each image only rebuilds when its specific dependencies change
          CODE_QUALITY_PATTERN='docker/mcp-code-quality\.Dockerfile'
          CODE_QUALITY_PATTERN="$CODE_QUALITY_PATTERN|tools/mcp/mcp_core_rust|tools/mcp/mcp_code_quality"
          CODE_QUALITY_PATTERN="$CODE_QUALITY_PATTERN|tools/rust/markdown-link-checker"
          docker_code_quality_count=$(grep -E "($CODE_QUALITY_PATTERN)" changed_files.txt | wc -l || echo "0")

          CONTENT_PATTERN='docker/mcp-content\.Dockerfile|tools/mcp/mcp_core_rust|tools/mcp/mcp_content_creation'
          docker_content_count=$(grep -E "($CONTENT_PATTERN)" changed_files.txt | wc -l || echo "0")

          GAEA2_PATTERN='docker/mcp-gaea2\.Dockerfile'
          GAEA2_PATTERN="$GAEA2_PATTERN|tools/mcp/mcp_core_rust|tools/mcp/mcp_gaea2"
          GAEA2_PATTERN="$GAEA2_PATTERN|docker/entrypoints/gaea2-entrypoint\.sh"
          docker_gaea2_count=$(grep -E "($GAEA2_PATTERN)" changed_files.txt | wc -l || echo "0")

          HTTP_BRIDGE_PATTERN='docker/mcp-http-bridge\.Dockerfile'
          HTTP_BRIDGE_PATTERN="$HTTP_BRIDGE_PATTERN|docker/requirements/requirements-http-bridge\.txt"
          HTTP_BRIDGE_PATTERN="$HTTP_BRIDGE_PATTERN|tools/cli/bridges/mcp-http-bridge\.py"
          docker_http_bridge_count=$(grep -E "($HTTP_BRIDGE_PATTERN)" changed_files.txt | wc -l || echo "0")

          PYTHON_CI_PATTERN='docker/python-ci\.Dockerfile|config/python/requirements\.txt|pyproject\.toml'
          PYTHON_CI_PATTERN="$PYTHON_CI_PATTERN|tools/rust/gh-validator"
          # Note: mcp_blender, mcp_comfyui, mcp_ai_toolkit, mcp_gaea2, mcp_virtual_character, mcp_video_editor, mcp_memory_explorer are now Rust (not triggering Python CI)
          PYTHON_CI_PATTERN="$PYTHON_CI_PATTERN|packages/sleeper_agents|automation/|\.flake8"
          docker_python_ci_count=$(grep -E "($PYTHON_CI_PATTERN)" changed_files.txt | wc -l || echo "0")

          # Set outputs
          echo "python_changed=$([[ $python_count -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "yaml_changed=$([[ $yaml_count -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "docker_changed=$([[ $docker_count -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "mcp_changed=$([[ $mcp_count -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "docs_changed=$([[ $docs_count -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "sleeper_changed=$([[ $sleeper_count -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "dashboard_changed=$([[ $dashboard_count -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "ci_changed=$([[ $ci_count -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "injection_toolkit_changed=$([[ $injection_toolkit_count -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "economic_agents_changed=$([[ $economic_agents_count -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "rust_tools_changed=$([[ $rust_tools_count -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "workflow_files_changed=$([[ $workflow_files_count -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "github_board_changed=$([[ $github_board_count -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "tex_changed=$([[ $tex_count -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "files_changed=$total_files" >> $GITHUB_OUTPUT

          # Docker image-specific outputs
          echo "docker_code_quality_changed=$([[ $docker_code_quality_count -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "docker_content_changed=$([[ $docker_content_count -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "docker_gaea2_changed=$([[ $docker_gaea2_count -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "docker_http_bridge_changed=$([[ $docker_http_bridge_count -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "docker_python_ci_changed=$([[ $docker_python_ci_count -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

          echo "[INFO] Change Summary:"
          echo "  Python files: $python_count"
          echo "  YAML/JSON files: $yaml_count"
          echo "  Docker files: $docker_count"
          echo "  MCP files: $mcp_count"
          echo "  Documentation: $docs_count"
          echo "  sleeper agents: $sleeper_count"
          echo "  Dashboard: $dashboard_count"
          echo "  CI/CD files: $ci_count"
          echo "  Injection Toolkit: $injection_toolkit_count"
          echo "  Economic Agents: $economic_agents_count"
          echo "  Rust CLI tools: $rust_tools_count"
          echo "  Workflow files: $workflow_files_count"
          echo "  GitHub Board: $github_board_count"
          echo "  LaTeX/TeX files: $tex_count"
          echo "  Total files: $total_files"
          echo ""
          echo "[INFO] Docker Image Rebuild Detection:"
          echo "  mcp-code-quality: $([[ $docker_code_quality_count -gt 0 ]] && echo 'REBUILD' || echo 'skip')"
          echo "  mcp-content: $([[ $docker_content_count -gt 0 ]] && echo 'REBUILD' || echo 'skip')"
          echo "  mcp-gaea2: $([[ $docker_gaea2_count -gt 0 ]] && echo 'REBUILD' || echo 'skip')"
          echo "  mcp-http-bridge: $([[ $docker_http_bridge_count -gt 0 ]] && echo 'REBUILD' || echo 'skip')"
          echo "  python-ci: $([[ $docker_python_ci_count -gt 0 ]] && echo 'REBUILD' || echo 'skip')"

  # Stage 1b: Build Rust CLI tools (for use by review jobs)
  # Uses local persistent cache on self-hosted runner - no GHA cache upload/download needed
  # Binaries are stored in ~/.cache/rust-cli-tools/ which persists across runs
  build-rust-tools:
    name: Build Rust CLI Tools
    needs: detect-changes
    runs-on: self-hosted
    timeout-minutes: 15
    env:
      # Persistent cache directory for Rust CLI tool binaries (survives workspace cleanup)
      RUST_CLI_CACHE: ${{ github.workspace }}/../.cache/rust-cli-tools
    steps:
      - name: Pre-checkout cleanup
        run: |
          if [ -d "outputs" ] || [ -d "evaluation_results" ] || [ -f ".git/index.lock" ]; then
            docker run --rm -v "$(pwd):/workspace" busybox:1.36.1 sh -c \
              "rm -rf /workspace/outputs /workspace/evaluation_results /workspace/.git/index.lock" || \
              sudo rm -rf outputs evaluation_results .git/index.lock 2>/dev/null || true
          fi

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
          clean: true
          token: ${{ secrets.GITHUB_TOKEN }}
          lfs: true

      # Local caching: Check if binaries exist in persistent cache and are up-to-date
      - name: Check local cache for Rust binaries
        id: local-cache
        run: |
          mkdir -p "$RUST_CLI_CACHE"

          # Check if all required binaries exist in cache
          CACHE_VALID=true
          for binary in github-agents board-manager md-link-checker git-guard mcp-gemini code-review-processor automation-cli; do
            if [ ! -f "$RUST_CLI_CACHE/$binary" ]; then
              echo "Cache miss: $binary not found"
              CACHE_VALID=false
              break
            fi
          done

          echo "cache_valid=$CACHE_VALID" >> $GITHUB_OUTPUT
          echo "Local cache valid: $CACHE_VALID"

      - name: Build github-agents-cli
        if: steps.local-cache.outputs.cache_valid != 'true' || needs.detect-changes.outputs.rust_tools_changed == 'true'
        run: |
          cd tools/rust/github-agents-cli
          cargo build --release
          cp target/release/github-agents "$RUST_CLI_CACHE/"
          echo "Built and cached github-agents"

      - name: Build board-manager
        if: steps.local-cache.outputs.cache_valid != 'true' || needs.detect-changes.outputs.rust_tools_changed == 'true'
        run: |
          cd tools/rust/board-manager
          cargo build --release
          cp target/release/board-manager "$RUST_CLI_CACHE/"
          echo "Built and cached board-manager"

      - name: Build markdown-link-checker
        if: steps.local-cache.outputs.cache_valid != 'true' || needs.detect-changes.outputs.rust_tools_changed == 'true'
        run: |
          cd tools/rust/markdown-link-checker
          cargo build --release
          cp target/release/md-link-checker "$RUST_CLI_CACHE/"
          echo "Built and cached md-link-checker"

      - name: Build git-guard
        if: steps.local-cache.outputs.cache_valid != 'true' || needs.detect-changes.outputs.rust_tools_changed == 'true'
        run: |
          cd tools/rust/git-guard
          cargo build --release
          cp target/release/git "$RUST_CLI_CACHE/git-guard"
          echo "Built and cached git-guard"

      - name: Build mcp-gemini
        if: steps.local-cache.outputs.cache_valid != 'true' || needs.detect-changes.outputs.rust_tools_changed == 'true'
        run: |
          cd tools/mcp/mcp_gemini
          cargo build --release
          cp target/release/mcp-gemini "$RUST_CLI_CACHE/"
          echo "Built and cached mcp-gemini"

      - name: Build code-review-processor
        if: steps.local-cache.outputs.cache_valid != 'true' || needs.detect-changes.outputs.rust_tools_changed == 'true'
        run: |
          cd tools/rust/code-review-processor
          cargo build --release
          cp target/release/code-review-processor "$RUST_CLI_CACHE/"
          echo "Built and cached code-review-processor"

      - name: Build automation-cli
        if: steps.local-cache.outputs.cache_valid != 'true' || needs.detect-changes.outputs.rust_tools_changed == 'true'
        run: |
          cd tools/rust/automation-cli
          cargo build --release
          cp target/release/automation-cli "$RUST_CLI_CACHE/"
          echo "Built and cached automation-cli"

      - name: Stage binaries for workflow
        run: |
          mkdir -p rust-binaries
          # Copy from persistent local cache
          cp "$RUST_CLI_CACHE/github-agents" rust-binaries/
          cp "$RUST_CLI_CACHE/board-manager" rust-binaries/
          cp "$RUST_CLI_CACHE/md-link-checker" rust-binaries/
          cp "$RUST_CLI_CACHE/git-guard" rust-binaries/
          cp "$RUST_CLI_CACHE/mcp-gemini" rust-binaries/
          cp "$RUST_CLI_CACHE/code-review-processor" rust-binaries/
          cp "$RUST_CLI_CACHE/automation-cli" rust-binaries/
          echo "Staged binaries from local cache:"
          ls -la rust-binaries/

      - name: Upload Rust binaries
        uses: actions/upload-artifact@v4
        with:
          name: rust-cli-tools
          path: rust-binaries/
          retention-days: 1

  # Stage 2: Gemini AI Code Review
  gemini-review:
    name: Gemini AI Code Review
    needs: [detect-changes, build-rust-tools]
    if: github.event_name == 'pull_request' && (contains(github.event.pull_request.labels.*.name, 'help wanted') || !github.event.pull_request.draft)
    uses: ./.github/workflows/ai-code-review.yml
    with:
      agent: gemini
      pr_number: ${{ github.event.pull_request.number }}
      enable_editor: true
      timeout_minutes: 30
      start_reaction_server: true
    secrets: inherit

  # Stage 2b: Codex AI Code Review (Secondary reviewer)
  codex-review:
    name: Codex AI Code Review
    needs: [detect-changes, build-rust-tools, gemini-review]
    if: |
      github.event_name == 'pull_request' &&
      (contains(github.event.pull_request.labels.*.name, 'help wanted') || !github.event.pull_request.draft) &&
      needs.gemini-review.result != 'skipped'
    uses: ./.github/workflows/ai-code-review.yml
    with:
      agent: codex
      pr_number: ${{ github.event.pull_request.number }}
      timeout_minutes: 15
      continue_on_error: true
      start_reaction_server: true
    secrets: inherit

  # Stage 2c: AgentCore Code Review (Optional - triggered by label)
  agentcore-review:
    name: AgentCore Code Review
    needs: [detect-changes, build-rust-tools]
    if: |
      github.event_name == 'pull_request' &&
      contains(github.event.pull_request.labels.*.name, 'agentcore-review') &&
      !github.event.pull_request.draft
    uses: ./.github/workflows/agentcore-code-review.yml
    with:
      pr_number: ${{ github.event.pull_request.number }}
      apply_fixes: false
      create_pr: false
      instructions: 'Focus on security issues, code quality, and best practices.'
      timeout_minutes: 15
    secrets:
      AGENTCORE_ENDPOINT: ${{ secrets.AGENTCORE_ENDPOINT }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}

  # Stage 2c: Agent Review Response (responds to Gemini/Codex feedback)
  agent-review-response:
    name: Agent Review Response
    needs: [detect-changes, build-rust-tools, gemini-review, codex-review]
    if: |
      always() &&
      !cancelled() &&
      github.event_name == 'pull_request' &&
      !github.event.pull_request.draft &&
      vars.ENABLE_AGENTS == 'true' &&
      !contains(github.event.pull_request.labels.*.name, 'no-auto-fix')
    runs-on: self-hosted
    timeout-minutes: 30
    outputs:
      made_changes: ${{ steps.agent-fix.outputs.made_changes }}
      iteration_count: ${{ steps.iteration.outputs.iteration_count }}
    env:
      PR_NUMBER: ${{ github.event.pull_request.number }}
      HEAD_BRANCH: ${{ github.head_ref }}
      GITHUB_TOKEN: ${{ secrets.AGENT_TOKEN }}
      GITHUB_REPOSITORY: ${{ github.repository }}
    steps:
      - name: Pre-checkout cleanup
        run: |
          if [ -d "outputs" ] || [ -d "evaluation_results" ] || [ -f ".git/index.lock" ]; then
            docker run --rm -v "$(pwd):/workspace" busybox:1.36.1 sh -c \
              "rm -rf /workspace/outputs /workspace/evaluation_results /workspace/.git/index.lock" || \
              sudo rm -rf outputs evaluation_results .git/index.lock 2>/dev/null || true
          fi

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          clean: false
          token: ${{ secrets.AGENT_TOKEN }}
          ref: ${{ github.head_ref }}
          lfs: true

      - name: Post-checkout setup
        run: |
          if [ -f "./automation/setup/docker/init-output-dirs.sh" ]; then
            ./automation/setup/docker/init-output-dirs.sh
          fi

      - name: Ensure clean working directory
        run: |
          git checkout -- . 2>/dev/null || true
          git clean -fd 2>/dev/null || true
          echo "Working directory reset to clean state"

      - name: Download Rust CLI tools
        uses: actions/download-artifact@v4
        with:
          name: rust-cli-tools
          path: rust-tools

      - name: Setup Rust CLI tools
        run: |
          if [ -f "rust-tools/github-agents" ]; then
            chmod +x rust-tools/github-agents
            mkdir -p tools/rust/github-agents-cli/target/release
            cp rust-tools/github-agents tools/rust/github-agents-cli/target/release/
            echo "Installed github-agents CLI"
          else
            echo "ERROR: github-agents binary not found in artifact!"
            exit 1
          fi

          if [ -f "rust-tools/automation-cli" ]; then
            chmod +x rust-tools/automation-cli
            mkdir -p tools/rust/automation-cli/target/release
            cp rust-tools/automation-cli tools/rust/automation-cli/target/release/
            echo "Installed automation-cli"
          else
            echo "WARNING: automation-cli binary not found in artifact"
          fi

      - name: Check iteration count
        id: iteration
        uses: ./.github/actions/agent-iteration-check
        with:
          pr_number: ${{ github.event.pull_request.number }}
          max_iterations: '5'
          agent_type: 'review-fix'
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip if max iterations reached
        if: steps.iteration.outputs.exceeded_max == 'true'
        run: |
          echo "Maximum iterations (5) reached for review-fix agent. Manual intervention required."
          echo "made_changes=false" >> $GITHUB_OUTPUT
          exit 0

      - name: Download review artifacts
        if: steps.iteration.outputs.should_skip != 'true'
        uses: actions/download-artifact@v6
        continue-on-error: true
        with:
          pattern: '*-review-${{ github.run_id }}-${{ github.run_attempt }}'
          merge-multiple: true
          path: .

      - name: Setup Node.js
        if: steps.iteration.outputs.should_skip != 'true'
        uses: ./.github/actions/setup-nodejs

      - name: Set Docker user environment
        if: steps.iteration.outputs.should_skip != 'true'
        run: source ./automation/setup/docker/set-docker-user.sh

      - name: Run agent review response
        id: agent-fix
        if: steps.iteration.outputs.should_skip != 'true'
        env:
          GEMINI_REVIEW_PATH: gemini-review.md
          CODEX_REVIEW_PATH: codex-review.md
          PR_NUMBER: ${{ github.event.pull_request.number }}
          BRANCH_NAME: ${{ github.head_ref }}
          ITERATION_COUNT: ${{ steps.iteration.outputs.iteration_count }}
        run: |
          echo "Running agent review response..."
          ./automation/ci-cd/agent-review-response.sh \
            "$PR_NUMBER" \
            "$BRANCH_NAME" \
            "$ITERATION_COUNT" \
            "5"

      - name: Cleanup output directories
        if: always()
        run: |
          if [ -f "./automation/ci-cd/cleanup-outputs.sh" ]; then
            ./automation/ci-cd/cleanup-outputs.sh
          fi

  # Stage 3a: Format check stage (after AI review cycle completes)
  format-check:
    name: Python Format Check
    needs: [detect-changes, gemini-review, codex-review, agent-review-response]
    if: |
      always() && !cancelled() &&
      needs.detect-changes.result == 'success' &&
      (needs.detect-changes.outputs.python_changed == 'true' ||
       needs.detect-changes.outputs.mcp_changed == 'true' ||
       !github.event.pull_request.draft)
    uses: ./.github/workflows/lint-stages.yml
    with:
      stage: format
      upload_artifacts: true
    secrets: inherit

  # Stage 3b: Basic lint stage
  basic-lint:
    name: Python Basic Lint
    needs: [detect-changes, gemini-review, codex-review, agent-review-response]
    if: |
      always() && !cancelled() &&
      needs.detect-changes.result == 'success' &&
      (needs.detect-changes.outputs.python_changed == 'true' ||
       needs.detect-changes.outputs.mcp_changed == 'true' ||
       !github.event.pull_request.draft)
    uses: ./.github/workflows/lint-stages.yml
    with:
      stage: basic
      upload_artifacts: true
    secrets: inherit

  # Stage 3c: Full lint stage (includes security & type checking)
  full-lint:
    name: Python Full Lint
    needs: [detect-changes, gemini-review, codex-review, format-check, basic-lint]
    if: |
      always() && !cancelled() &&
      needs.detect-changes.result == 'success' &&
      (needs.detect-changes.outputs.python_changed == 'true' ||
       needs.detect-changes.outputs.mcp_changed == 'true' ||
       !github.event.pull_request.draft)
    uses: ./.github/workflows/lint-stages.yml
    with:
      stage: full
      upload_artifacts: true
    secrets: inherit

  # Stage 3d: Link check for documentation
  link-check:
    name: Documentation Link Check
    needs: [detect-changes, gemini-review, codex-review, agent-review-response]
    if: |
      always() && !cancelled() &&
      needs.detect-changes.result == 'success' &&
      (needs.detect-changes.outputs.docs_changed == 'true' ||
       !github.event.pull_request.draft)
    uses: ./.github/workflows/lint-stages.yml
    with:
      stage: links
      upload_artifacts: true
    secrets: inherit

  # Stage 4: YAML/JSON validation
  config-validation:
    name: Config File Validation
    needs: [detect-changes, gemini-review, codex-review, agent-review-response]
    if: |
      always() && !cancelled() &&
      needs.detect-changes.result == 'success' &&
      needs.detect-changes.outputs.yaml_changed == 'true'
    uses: ./.github/workflows/validation-stages.yml
    with:
      stage: config
    secrets: inherit

  # Stage 4b: Workflow file validation (when workflow files changed or CI files changed)
  workflow-validation:
    name: Workflow File Validation
    needs: [detect-changes, gemini-review, codex-review, agent-review-response]
    if: |
      always() && !cancelled() &&
      needs.detect-changes.result == 'success' &&
      (needs.detect-changes.outputs.workflow_files_changed == 'true' ||
       needs.detect-changes.outputs.ci_changed == 'true')
    uses: ./.github/workflows/validation-stages.yml
    with:
      stage: workflows
    secrets: inherit

  # Stage 4c: Comprehensive YAML linting (when YAML files changed)
  yaml-lint:
    name: YAML Lint All Files
    needs: [detect-changes, gemini-review, codex-review, agent-review-response]
    if: |
      always() && !cancelled() &&
      needs.detect-changes.result == 'success' &&
      needs.detect-changes.outputs.yaml_changed == 'true'
    uses: ./.github/workflows/validation-stages.yml
    with:
      stage: yaml-all
    secrets: inherit

  # Stage 5: Test execution (after AI review cycle and linting)
  test-suite:
    name: Test Suite
    needs: [detect-changes, build-rust-tools, gemini-review, codex-review, agent-review-response, format-check, basic-lint, full-lint]
    if: |
      always() && !cancelled() &&
      needs.detect-changes.result == 'success' &&
      (needs.detect-changes.outputs.python_changed == 'true' ||
       needs.detect-changes.outputs.mcp_changed == 'true') &&
      !github.event.inputs.skip_tests
    runs-on: self-hosted
    timeout-minutes: 15
    steps:
      - name: Pre-checkout cleanup
        run: |
          if [ -d "outputs" ] || [ -d "evaluation_results" ] || [ -f ".git/index.lock" ]; then
            docker run --rm -v "$(pwd):/workspace" busybox:1.36.1 sh -c \
              "rm -rf /workspace/outputs /workspace/evaluation_results /workspace/.git/index.lock" || \
              sudo rm -rf outputs evaluation_results .git/index.lock 2>/dev/null || true
          fi

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          clean: true
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}
          lfs: true

      - name: Download automation-cli
        uses: actions/download-artifact@v4
        with:
          name: rust-cli-tools
          path: rust-tools

      - name: Setup automation-cli
        run: |
          if [ -f "rust-tools/automation-cli" ]; then
            chmod +x rust-tools/automation-cli
            mkdir -p tools/rust/automation-cli/target/release
            cp rust-tools/automation-cli tools/rust/automation-cli/target/release/
            echo "Installed automation-cli"
          else
            echo "ERROR: automation-cli not found in artifact"
            exit 1
          fi

      - name: Run tests
        env:
          MCP_GAEA2_URL: http://192.168.0.152:8007
        run: |
          echo "Running test suite..."
          ./automation/ci-cd/run-ci.sh test

      - name: Generate coverage summary
        if: always()
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage.xml ]; then
            python3 -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('coverage.xml')
          root = tree.getroot()
          line_rate = float(root.get('line-rate', 0)) * 100
          branch_rate = float(root.get('branch-rate', 0)) * 100
          packages = root.findall('.//package')
          classes = root.findall('.//class')
          print(f'| Metric | Value |')
          print(f'|--------|-------|')
          print(f'| Line Coverage | {line_rate:.1f}% |')
          print(f'| Branch Coverage | {branch_rate:.1f}% |')
          print(f'| Files Analyzed | {len(classes)} |')
          print(f'| Packages | {len(packages)} |')
          " >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Full HTML report available in workflow artifacts" >> $GITHUB_STEP_SUMMARY
          else
            echo "No coverage.xml found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            coverage.xml
            htmlcov/
          retention-days: 14

  # Stage 6: MCP Server validation (after AI review cycle)
  mcp-validation:
    name: MCP Server Validation
    needs: [detect-changes, gemini-review, codex-review, agent-review-response]
    if: |
      always() && !cancelled() &&
      needs.detect-changes.result == 'success' &&
      needs.detect-changes.outputs.mcp_changed == 'true' &&
      !github.event.pull_request.draft
    runs-on: self-hosted
    timeout-minutes: 10
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Pre-checkout cleanup
        run: |
          if [ -d "outputs" ] || [ -d "evaluation_results" ] || [ -f ".git/index.lock" ]; then
            docker run --rm -v "$(pwd):/workspace" busybox:1.36.1 sh -c \
              "rm -rf /workspace/outputs /workspace/evaluation_results /workspace/.git/index.lock" || \
              sudo rm -rf outputs evaluation_results .git/index.lock 2>/dev/null || true
          fi

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          clean: true
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}
          lfs: true

      - name: Post-checkout setup
        run: |
          if [ -f "./automation/setup/docker/init-output-dirs.sh" ]; then
            ./automation/setup/docker/init-output-dirs.sh
          fi

      - name: Set Docker user environment
        run: source ./automation/setup/docker/set-docker-user.sh

      - name: Start modular MCP servers with health check
        uses: ./.github/actions/docker-compose-health-check
        with:
          services: 'mcp-code-quality mcp-content-creation mcp-gaea2'
          profiles: 'services'
          health-endpoint: 'http://localhost:8010/health'
          timeout: '60'
          build: 'true'

      - name: Test MCP servers functionality
        run: |
          echo "Testing modular MCP servers..."
          ./automation/ci-cd/test-mcp-servers.sh || {
            # Fallback to inline test if script doesn't exist
            for port_name in "8010:Code Quality" "8011:Content Creation" "8007:Gaea2"; do
              port="${port_name%%:*}"
              name="${port_name#*:}"
              echo "Testing $name MCP (port $port)..."
              for i in {1..15}; do
                if curl -f "http://localhost:$port/health" 2>/dev/null; then
                  echo "$name MCP is ready"
                  break
                fi
                if [ $i -eq 15 ]; then
                  echo "$name MCP failed to respond"
                  exit 1
                fi
                sleep 2
              done
            done
            docker compose run --rm python-ci python automation/testing/test_all_servers.py --quick
          }

      - name: View MCP server logs
        if: failure()
        run: docker compose logs mcp-code-quality mcp-content-creation mcp-gaea2

      - name: Stop MCP server
        if: always()
        run: |
          docker compose down --rmi local --remove-orphans || true
          ./automation/ci-cd/cleanup-outputs.sh || true

  # Stage 7: sleeper agents Tests
  sleeper-agents-tests:
    name: sleeper agents Tests
    needs: [detect-changes, format-check, basic-lint]
    if: needs.detect-changes.outputs.sleeper_changed == 'true'
    uses: ./.github/workflows/sleeper-agents-tests.yml
    secrets: inherit

  # Stage 7b: Dashboard Tests
  dashboard-tests:
    name: Dashboard Tests
    needs: [detect-changes, format-check, basic-lint]
    if: needs.detect-changes.outputs.dashboard_changed == 'true'
    uses: ./.github/workflows/dashboard-tests.yml
    secrets: inherit

  # Stage 7c: Build Documentation (LaTeX)
  build-docs:
    name: Build Documentation
    needs: [detect-changes]
    if: needs.detect-changes.outputs.tex_changed == 'true'
    uses: ./.github/workflows/build-docs.yml
    secrets: inherit

  # Stage 8: Gaea2 MCP Integration Tests (after AI review cycle)
  gaea2-integration-tests:
    name: Gaea2 MCP Integration Tests
    needs: [detect-changes, gemini-review, codex-review, agent-review-response]
    if: |
      always() && !cancelled() &&
      needs.detect-changes.result == 'success' &&
      needs.detect-changes.outputs.mcp_changed == 'true'
    uses: ./.github/workflows/gaea2-integration-tests.yml
    with:
      server_url: 'http://192.168.0.152:8007'

  # Stage 8b: Injection Toolkit Tests (Rust) - after AI review cycle
  injection-toolkit-tests:
    name: Injection Toolkit Tests
    needs: [detect-changes, build-rust-tools, gemini-review, codex-review, agent-review-response]
    if: |
      always() && !cancelled() &&
      needs.detect-changes.result == 'success' &&
      needs.detect-changes.outputs.injection_toolkit_changed == 'true'
    runs-on: self-hosted
    timeout-minutes: 30
    env:
      CARGO_TERM_COLOR: always
    steps:
      - name: Pre-checkout cleanup
        run: |
          if [ -d "outputs" ] || [ -d "evaluation_results" ] || [ -f ".git/index.lock" ]; then
            docker run --rm -v "$(pwd):/workspace" busybox:1.36.1 sh -c \
              "rm -rf /workspace/outputs /workspace/evaluation_results /workspace/.git/index.lock" || \
              sudo rm -rf outputs evaluation_results .git/index.lock 2>/dev/null || true
          fi

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          clean: true
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}
          lfs: true

      - name: Download automation-cli
        uses: actions/download-artifact@v4
        with:
          name: rust-cli-tools
          path: rust-tools

      - name: Setup automation-cli
        run: |
          if [ -f "rust-tools/automation-cli" ]; then
            chmod +x rust-tools/automation-cli
            mkdir -p tools/rust/automation-cli/target/release
            cp rust-tools/automation-cli tools/rust/automation-cli/target/release/
            echo "Installed automation-cli"
          else
            echo "ERROR: automation-cli not found in artifact"
            exit 1
          fi

      - name: Check formatting (containerized)
        run: ./automation/ci-cd/run-ci.sh rust-fmt

      - name: Run clippy (containerized)
        run: ./automation/ci-cd/run-ci.sh rust-clippy

      - name: Build workspace (containerized)
        run: |
          ./automation/ci-cd/run-ci.sh rust-build
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "All crates built successfully (containerized)" >> $GITHUB_STEP_SUMMARY

      - name: Run unit tests (containerized)
        run: |
          ./automation/ci-cd/run-ci.sh rust-test
          echo "## Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "All unit tests passed (containerized)" >> $GITHUB_STEP_SUMMARY

      - name: Run Loom concurrency tests (containerized)
        run: |
          ./automation/ci-cd/run-ci.sh rust-loom
          echo "## Loom Concurrency Tests" >> $GITHUB_STEP_SUMMARY
          echo "Seqlock memory ordering verified across all interleavings" >> $GITHUB_STEP_SUMMARY

      - name: Run Miri UB detection (containerized)
        run: |
          ./automation/ci-cd/run-ci.sh rust-miri
          echo "## Miri Analysis" >> $GITHUB_STEP_SUMMARY
          echo "No undefined behavior detected" >> $GITHUB_STEP_SUMMARY

      - name: Cross-compile check - x86_64 Linux (containerized)
        run: |
          ./automation/ci-cd/run-ci.sh rust-cross-linux
          echo "## Cross-Compilation: x86_64-unknown-linux-gnu" >> $GITHUB_STEP_SUMMARY
          echo "Core crates compile successfully" >> $GITHUB_STEP_SUMMARY

      - name: Cross-compile check - Windows (containerized)
        run: |
          ./automation/ci-cd/run-ci.sh rust-cross-windows
          echo "## Cross-Compilation: x86_64-pc-windows-gnu" >> $GITHUB_STEP_SUMMARY
          echo "Core crates compile successfully" >> $GITHUB_STEP_SUMMARY

      - name: License/security audit (containerized)
        run: |
          ./automation/ci-cd/run-ci.sh rust-deny
          echo "## License & Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "No license or security issues found" >> $GITHUB_STEP_SUMMARY

      - name: Generate test summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## Injection Toolkit CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "All checks: fully containerized (rust-ci, rust-ci-nightly)" >> $GITHUB_STEP_SUMMARY

  # Stage 8c: Economic Agents Tests (Rust) - after AI review cycle
  economic-agents-tests:
    name: Economic Agents Tests
    needs: [detect-changes, build-rust-tools, gemini-review, codex-review, agent-review-response]
    if: |
      always() && !cancelled() &&
      needs.detect-changes.result == 'success' &&
      needs.detect-changes.outputs.economic_agents_changed == 'true'
    runs-on: self-hosted
    timeout-minutes: 20
    env:
      CARGO_TERM_COLOR: always
    steps:
      - name: Pre-checkout cleanup
        run: |
          if [ -d "outputs" ] || [ -d "evaluation_results" ] || [ -f ".git/index.lock" ]; then
            docker run --rm -v "$(pwd):/workspace" busybox:1.36.1 sh -c \
              "rm -rf /workspace/outputs /workspace/evaluation_results /workspace/.git/index.lock" || \
              sudo rm -rf outputs evaluation_results .git/index.lock 2>/dev/null || true
          fi

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          clean: true
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}
          lfs: true

      - name: Download automation-cli
        uses: actions/download-artifact@v4
        with:
          name: rust-cli-tools
          path: rust-tools

      - name: Setup automation-cli
        run: |
          if [ -f "rust-tools/automation-cli" ]; then
            chmod +x rust-tools/automation-cli
            mkdir -p tools/rust/automation-cli/target/release
            cp rust-tools/automation-cli tools/rust/automation-cli/target/release/
            echo "Installed automation-cli"
          else
            echo "ERROR: automation-cli not found in artifact"
            exit 1
          fi

      - name: Check formatting (containerized)
        run: ./automation/ci-cd/run-ci.sh econ-fmt

      - name: Run clippy (containerized)
        run: ./automation/ci-cd/run-ci.sh econ-clippy

      - name: Build workspace (containerized)
        run: |
          ./automation/ci-cd/run-ci.sh econ-build
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "All economic_agents crates built successfully (containerized)" >> $GITHUB_STEP_SUMMARY

      - name: Run unit tests (containerized)
        run: |
          ./automation/ci-cd/run-ci.sh econ-test
          echo "## Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "All economic_agents tests passed (containerized)" >> $GITHUB_STEP_SUMMARY

      - name: License/security audit (containerized)
        run: |
          ./automation/ci-cd/run-ci.sh econ-deny
          echo "## License & Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "No license or security issues found" >> $GITHUB_STEP_SUMMARY

      - name: Generate documentation (containerized)
        run: |
          ./automation/ci-cd/run-ci.sh econ-doc
          echo "## Documentation" >> $GITHUB_STEP_SUMMARY
          echo "API documentation generated successfully" >> $GITHUB_STEP_SUMMARY

      - name: Generate test summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## Economic Agents CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "All checks: fully containerized (rust-ci)" >> $GITHUB_STEP_SUMMARY

  # Stage 8d: GitHub Board Tests - after AI review cycle
  github-board-tests:
    name: GitHub Board Tests
    needs: [detect-changes, gemini-review, codex-review, agent-review-response]
    if: |
      always() && !cancelled() &&
      needs.detect-changes.result == 'success' &&
      needs.detect-changes.outputs.github_board_changed == 'true'
    uses: ./.github/workflows/test-github-board.yml
    secrets: inherit

  # Stage 9: Docker image validation (after AI review cycle and linting)
  docker-validation:
    name: Docker Image Validation
    needs: [detect-changes, gemini-review, codex-review, agent-review-response, format-check, basic-lint, full-lint]
    if: |
      always() && !cancelled() &&
      needs.detect-changes.result == 'success' &&
      (needs.detect-changes.outputs.docker_code_quality_changed == 'true' ||
       needs.detect-changes.outputs.docker_content_changed == 'true' ||
       needs.detect-changes.outputs.docker_gaea2_changed == 'true' ||
       needs.detect-changes.outputs.docker_http_bridge_changed == 'true' ||
       needs.detect-changes.outputs.docker_python_ci_changed == 'true' ||
       github.event.inputs.force_docker_validation) &&
      !github.event.pull_request.draft
    runs-on: self-hosted
    timeout-minutes: 45
    steps:
      - name: Pre-checkout cleanup
        run: |
          if [ -d "outputs" ] || [ -d "evaluation_results" ] || [ -f ".git/index.lock" ]; then
            docker run --rm -v "$(pwd):/workspace" busybox:1.36.1 sh -c \
              "rm -rf /workspace/outputs /workspace/evaluation_results /workspace/.git/index.lock" || \
              sudo rm -rf outputs evaluation_results .git/index.lock 2>/dev/null || true
          fi

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          clean: true
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}
          lfs: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=pr
            type=sha,prefix=pr-${{ github.event.pull_request.number }}-

      # Docker builds use local BuildKit cache (persistent on self-hosted runner)
      # No GHA cache upload/download needed - layers are already on disk
      - name: Build Code Quality MCP image
        if: needs.detect-changes.outputs.docker_code_quality_changed == 'true' || github.event.inputs.force_docker_validation
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/mcp-code-quality.Dockerfile
          push: false
          load: true
          tags: |
            ${{ env.REGISTRY }}/andrewaltimit/template-repo:pr-${{ github.event.pull_request.number }}-mcp-code-quality
            ${{ env.REGISTRY }}/andrewaltimit/template-repo:pr-${{ github.event.pull_request.number }}-mcp-code-quality-${{ github.sha }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Build Content Creation MCP image
        if: needs.detect-changes.outputs.docker_content_changed == 'true' || github.event.inputs.force_docker_validation
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/mcp-content.Dockerfile
          push: false
          load: true
          tags: |
            ${{ env.REGISTRY }}/andrewaltimit/template-repo:pr-${{ github.event.pull_request.number }}-mcp-content
            ${{ env.REGISTRY }}/andrewaltimit/template-repo:pr-${{ github.event.pull_request.number }}-mcp-content-${{ github.sha }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Build Gaea2 MCP image
        if: needs.detect-changes.outputs.docker_gaea2_changed == 'true' || github.event.inputs.force_docker_validation
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/mcp-gaea2.Dockerfile
          push: false
          load: true
          tags: |
            ${{ env.REGISTRY }}/andrewaltimit/template-repo:pr-${{ github.event.pull_request.number }}-mcp-gaea2
            ${{ env.REGISTRY }}/andrewaltimit/template-repo:pr-${{ github.event.pull_request.number }}-mcp-gaea2-${{ github.sha }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Build MCP HTTP Bridge image
        if: needs.detect-changes.outputs.docker_http_bridge_changed == 'true' || github.event.inputs.force_docker_validation
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/mcp-http-bridge.Dockerfile
          push: false
          load: true
          tags: |
            ${{ env.REGISTRY }}/andrewaltimit/template-repo:pr-${{ github.event.pull_request.number }}-mcp-http-bridge
            ${{ env.REGISTRY }}/andrewaltimit/template-repo:pr-${{ github.event.pull_request.number }}-mcp-http-bridge-${{ github.sha }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Build Python CI image
        if: needs.detect-changes.outputs.docker_python_ci_changed == 'true' || github.event.inputs.force_docker_validation
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/python-ci.Dockerfile
          push: false
          load: true
          tags: |
            ${{ env.REGISTRY }}/andrewaltimit/template-repo:pr-${{ github.event.pull_request.number }}-python-ci
            ${{ env.REGISTRY }}/andrewaltimit/template-repo:pr-${{ github.event.pull_request.number }}-python-ci-${{ github.sha }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Docker build summary
        run: |
          echo "## Docker Image Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| mcp-code-quality | ${{ needs.detect-changes.outputs.docker_code_quality_changed == 'true' && 'Built' || 'Skipped (no changes)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| mcp-content | ${{ needs.detect-changes.outputs.docker_content_changed == 'true' && 'Built' || 'Skipped (no changes)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| mcp-gaea2 | ${{ needs.detect-changes.outputs.docker_gaea2_changed == 'true' && 'Built' || 'Skipped (no changes)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| mcp-http-bridge | ${{ needs.detect-changes.outputs.docker_http_bridge_changed == 'true' && 'Built' || 'Skipped (no changes)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| python-ci | ${{ needs.detect-changes.outputs.docker_python_ci_changed == 'true' && 'Built' || 'Skipped (no changes)' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Test Docker Compose with health check
        if: |
          needs.detect-changes.outputs.docker_code_quality_changed == 'true' ||
          needs.detect-changes.outputs.docker_content_changed == 'true' ||
          needs.detect-changes.outputs.docker_gaea2_changed == 'true'
        uses: ./.github/actions/docker-compose-health-check
        with:
          services: 'mcp-code-quality mcp-content-creation mcp-gaea2'
          profiles: 'services'
          health-endpoint: 'http://localhost:8010/health'
          timeout: '60'
          build: 'false'

      - name: Cleanup PR-specific images
        if: always()
        uses: ./.github/actions/docker-cleanup
        with:
          image-pattern: 'pr-${{ github.event.pull_request.number }}-'
          prune-dangling: true

      - name: Stop services
        if: always()
        run: |
          docker compose down --rmi local --remove-orphans || true
          ./automation/ci-cd/cleanup-outputs.sh || true

  # Agent Failure Handler - attempts to fix format/lint/test failures
  agent-failure-handler:
    name: Agent Failure Handler
    needs:
      - detect-changes
      - build-rust-tools
      - gemini-review
      - codex-review
      - agent-review-response
      - format-check
      - basic-lint
      - full-lint
      - test-suite
      - sleeper-agents-tests
      - dashboard-tests
    if: |
      failure() &&
      github.event_name == 'pull_request' &&
      !github.event.pull_request.draft &&
      vars.ENABLE_AGENTS == 'true' &&
      !contains(github.event.pull_request.labels.*.name, 'no-auto-fix') &&
      (needs.format-check.result == 'failure' ||
       needs.basic-lint.result == 'failure' ||
       needs.full-lint.result == 'failure' ||
       needs.test-suite.result == 'failure' ||
       needs.sleeper-agents-tests.result == 'failure' ||
       needs.dashboard-tests.result == 'failure')
    runs-on: self-hosted
    timeout-minutes: 45
    outputs:
      made_changes: ${{ steps.agent-fix.outputs.made_changes }}
    env:
      PR_NUMBER: ${{ github.event.pull_request.number }}
      HEAD_BRANCH: ${{ github.head_ref }}
      GITHUB_TOKEN: ${{ secrets.AGENT_TOKEN }}
      GITHUB_REPOSITORY: ${{ github.repository }}
      FORMAT_CHECK_RESULT: ${{ needs.format-check.result }}
      BASIC_LINT_RESULT: ${{ needs.basic-lint.result }}
      FULL_LINT_RESULT: ${{ needs.full-lint.result }}
      TEST_SUITE_RESULT: ${{ needs.test-suite.result }}
      SLEEPER_AGENTS_RESULT: ${{ needs.sleeper-agents-tests.result }}
      DASHBOARD_TESTS_RESULT: ${{ needs.dashboard-tests.result }}
    steps:
      - name: Pre-checkout cleanup
        run: |
          if [ -d "outputs" ] || [ -d "evaluation_results" ] || [ -f ".git/index.lock" ]; then
            docker run --rm -v "$(pwd):/workspace" busybox:1.36.1 sh -c \
              "rm -rf /workspace/outputs /workspace/evaluation_results /workspace/.git/index.lock" || \
              sudo rm -rf outputs evaluation_results .git/index.lock 2>/dev/null || true
          fi

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          clean: false
          token: ${{ secrets.AGENT_TOKEN }}
          ref: ${{ github.head_ref }}
          lfs: true

      - name: Post-checkout setup
        run: |
          if [ -f "./automation/setup/docker/init-output-dirs.sh" ]; then
            ./automation/setup/docker/init-output-dirs.sh
          fi

      - name: Ensure clean working directory
        run: |
          git checkout -- . 2>/dev/null || true
          git clean -fd 2>/dev/null || true

      - name: Download Rust CLI tools
        uses: actions/download-artifact@v4
        with:
          name: rust-cli-tools
          path: rust-tools

      - name: Setup Rust CLI tools
        run: |
          if [ -f "rust-tools/github-agents" ]; then
            chmod +x rust-tools/github-agents
            mkdir -p tools/rust/github-agents-cli/target/release
            cp rust-tools/github-agents tools/rust/github-agents-cli/target/release/
            echo "Installed github-agents CLI"
          else
            echo "ERROR: github-agents binary not found in artifact!"
            exit 1
          fi

      - name: Check iteration count
        id: iteration
        uses: ./.github/actions/agent-iteration-check
        with:
          pr_number: ${{ github.event.pull_request.number }}
          max_iterations: '5'
          agent_type: 'failure-fix'
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip if max iterations reached
        if: steps.iteration.outputs.exceeded_max == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Maximum iterations (5) reached for failure-fix agent. Manual intervention required."
          gh pr comment "${{ github.event.pull_request.number }}" --body "$(cat << 'EOF'
          ## Failure Handler Agent - Max Iterations Reached
          <!-- agent-metadata:type=failure-fix:iteration=${{ steps.iteration.outputs.iteration_count }}:limit-reached -->

          The **Failure Handler Agent** has attempted to fix pipeline failures 5 times without success.
          Manual intervention is required to resolve the remaining issues.

          **Failed checks:**
          - Format Check: ${{ needs.format-check.result }}
          - Basic Lint: ${{ needs.basic-lint.result }}
          - Full Lint: ${{ needs.full-lint.result }}
          - Test Suite: ${{ needs.test-suite.result }}
          - Sleeper Agents Tests: ${{ needs.sleeper-agents-tests.result }}
          - Dashboard Tests: ${{ needs.dashboard-tests.result }}

          **Note:** The review-fix and failure-fix agents have separate iteration counters.

          Please review the failure logs and fix the issues manually.
          EOF
          )"
          echo "made_changes=false" >> $GITHUB_OUTPUT
          exit 0

      - name: Setup Node.js
        if: steps.iteration.outputs.exceeded_max != 'true'
        uses: ./.github/actions/setup-nodejs

      - name: Set Docker user environment
        if: steps.iteration.outputs.exceeded_max != 'true'
        run: source ./automation/setup/docker/set-docker-user.sh

      - name: Run agent failure handler
        id: agent-fix
        if: steps.iteration.outputs.exceeded_max != 'true'
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          BRANCH_NAME: ${{ github.head_ref }}
          ITERATION_COUNT: ${{ steps.iteration.outputs.iteration_count }}
        run: |
          echo "Running agent failure handler..."
          # Build failure types based on which jobs failed
          FAILURE_TYPES=""
          if [ "$FORMAT_CHECK_RESULT" = "failure" ] || [ "$BASIC_LINT_RESULT" = "failure" ] || [ "$FULL_LINT_RESULT" = "failure" ]; then
            FAILURE_TYPES="format,lint"
          fi
          if [ "$TEST_SUITE_RESULT" = "failure" ] || [ "$SLEEPER_AGENTS_RESULT" = "failure" ] || [ "$DASHBOARD_TESTS_RESULT" = "failure" ]; then
            if [ -n "$FAILURE_TYPES" ]; then
              FAILURE_TYPES="$FAILURE_TYPES,test"
            else
              FAILURE_TYPES="test"
            fi
          fi
          echo "Failure types: $FAILURE_TYPES"
          ./automation/ci-cd/agent-failure-handler.sh \
            "$PR_NUMBER" \
            "$BRANCH_NAME" \
            "$ITERATION_COUNT" \
            "5" \
            "$FAILURE_TYPES"

      - name: Cleanup output directories
        if: always()
        run: |
          if [ -f "./automation/ci-cd/cleanup-outputs.sh" ]; then
            ./automation/ci-cd/cleanup-outputs.sh
          fi

  # Final status and summary
  pr-status:
    name: PR Status Summary
    needs:
      - detect-changes
      - gemini-review
      - codex-review
      - agent-review-response
      - format-check
      - basic-lint
      - full-lint
      - link-check
      - config-validation
      - workflow-validation
      - yaml-lint
      - test-suite
      - mcp-validation
      - sleeper-agents-tests
      - dashboard-tests
      - gaea2-integration-tests
      - injection-toolkit-tests
      - economic-agents-tests
      - github-board-tests
      - docker-validation
      - build-docs
      - agent-failure-handler
    if: always()
    runs-on: self-hosted
    steps:
      - name: Generate status summary
        run: |
          echo "## PR Validation Summary"
          echo ""
          echo "**Files changed:** ${{ needs.detect-changes.outputs.files_changed }}"
          echo "**Python files:** ${{ needs.detect-changes.outputs.python_changed }}"
          echo "**Config files:** ${{ needs.detect-changes.outputs.yaml_changed }}"
          echo "**Docker files:** ${{ needs.detect-changes.outputs.docker_changed }}"
          echo "**MCP files:** ${{ needs.detect-changes.outputs.mcp_changed }}"
          echo "**Dashboard files:** ${{ needs.detect-changes.outputs.dashboard_changed }}"
          echo ""
          echo "**Validation Results:**"
          echo "- Change Detection: ${{ needs.detect-changes.result }}"
          echo "- Gemini AI Review: ${{ needs.gemini-review.result }}"
          echo "- Codex AI Review: ${{ needs.codex-review.result }}"
          echo "- Format Check: ${{ needs.format-check.result }}"
          echo "- Basic Lint: ${{ needs.basic-lint.result }}"
          echo "- Full Lint: ${{ needs.full-lint.result }}"
          echo "- Link Check: ${{ needs.link-check.result }}"
          echo "- Config Validation: ${{ needs.config-validation.result }}"
          echo "- Workflow Validation: ${{ needs.workflow-validation.result }}"
          echo "- YAML Lint: ${{ needs.yaml-lint.result }}"
          echo "- Test Suite: ${{ needs.test-suite.result }}"
          echo "- MCP Validation: ${{ needs.mcp-validation.result }}"
          echo "- sleeper agents: ${{ needs.sleeper-agents-tests.result }}"
          echo "- Dashboard Tests: ${{ needs.dashboard-tests.result }}"
          echo "- Gaea2 Integration Tests: ${{ needs.gaea2-integration-tests.result }}"
          echo "- Injection Toolkit Tests: ${{ needs.injection-toolkit-tests.result }}"
          echo "- Economic Agents Tests: ${{ needs.economic-agents-tests.result }}"
          echo "- GitHub Board Tests: ${{ needs.github-board-tests.result }}"
          echo "- Docker Validation: ${{ needs.docker-validation.result }}"
          echo "- Build Documentation: ${{ needs.build-docs.result }}"

          # Check for failures (AI reviews are advisory, not blocking)
          if [[ "${{ needs.detect-changes.result }}" == "failure" ||
                "${{ needs.format-check.result }}" == "failure" ||
                "${{ needs.basic-lint.result }}" == "failure" ||
                "${{ needs.full-lint.result }}" == "failure" ||
                "${{ needs.link-check.result }}" == "failure" ||
                "${{ needs.config-validation.result }}" == "failure" ||
                "${{ needs.workflow-validation.result }}" == "failure" ||
                "${{ needs.yaml-lint.result }}" == "failure" ||
                "${{ needs.test-suite.result }}" == "failure" ||
                "${{ needs.mcp-validation.result }}" == "failure" ||
                "${{ needs.sleeper-agents-tests.result }}" == "failure" ||
                "${{ needs.dashboard-tests.result }}" == "failure" ||
                "${{ needs.gaea2-integration-tests.result }}" == "failure" ||
                "${{ needs.injection-toolkit-tests.result }}" == "failure" ||
                "${{ needs.economic-agents-tests.result }}" == "failure" ||
                "${{ needs.github-board-tests.result }}" == "failure" ||
                "${{ needs.docker-validation.result }}" == "failure" ||
                "${{ needs.build-docs.result }}" == "failure" ]]; then
            echo ""
            echo "PR validation failed - please review the failed checks"
            exit 1
          fi

          echo ""
          echo "PR validation completed successfully!"

      - name: Post PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const results = {
              'change-detection': '${{ needs.detect-changes.result }}',
              'gemini-review': '${{ needs.gemini-review.result }}',
              'codex-review': '${{ needs.codex-review.result }}',
              'format-check': '${{ needs.format-check.result }}',
              'basic-lint': '${{ needs.basic-lint.result }}',
              'full-lint': '${{ needs.full-lint.result }}',
              'link-check': '${{ needs.link-check.result }}',
              'config-validation': '${{ needs.config-validation.result }}',
              'workflow-validation': '${{ needs.workflow-validation.result }}',
              'yaml-lint': '${{ needs.yaml-lint.result }}',
              'test-suite': '${{ needs.test-suite.result }}',
              'mcp-validation': '${{ needs.mcp-validation.result }}',
              'sleeper-agents': '${{ needs.sleeper-agents-tests.result }}',
              'dashboard-tests': '${{ needs.dashboard-tests.result }}',
              'gaea2-integration-tests': '${{ needs.gaea2-integration-tests.result }}',
              'injection-toolkit': '${{ needs.injection-toolkit-tests.result }}',
              'economic-agents': '${{ needs.economic-agents-tests.result }}',
              'github-board': '${{ needs.github-board-tests.result }}',
              'build-docs': '${{ needs.build-docs.result }}',
              'docker-validation': '${{ needs.docker-validation.result }}'
            };

            const filesChanged = '${{ needs.detect-changes.outputs.files_changed }}';
            const isDraft = context.payload.pull_request.draft;

            let comment = '## PR Validation Results\n\n';
            comment += `**Files changed:** ${filesChanged}\n\n`;
            comment += '| Check | Status |\n|-------|--------|\n';

            Object.entries(results).forEach(([check, status]) => {
              let icon = status === 'success' ? 'pass' :
                        status === 'failure' ? 'fail' :
                        status === 'skipped' ? 'skip' : 'run';

              let displayName = check.charAt(0).toUpperCase() + check.slice(1).replace('-', ' ');
              comment += `| ${displayName} | ${icon} |\n`;
            });

            if (isDraft) {
              comment += '\n> **Draft PR** - Some validations may be skipped.\n';
            }

            comment += '\n*Generated by automated PR validation*';

            try {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('Could not post comment:', error.message);
            }
