---
name: Build Documentation

on:
  push:
    paths:
      - 'packages/sleeper_agents/docs/**/*.tex'
      - 'docs/integrations/ai-services/**/*.tex'
      - 'docs/projections/latex/**/*.tex'
      - 'automation/ci-cd/build-latex-doc.sh'
      - '.github/workflows/build-docs.yml'
  pull_request:
    paths:
      - 'packages/sleeper_agents/docs/**/*.tex'
      - 'docs/integrations/ai-services/**/*.tex'
      - 'docs/projections/latex/**/*.tex'
      - 'automation/ci-cd/build-latex-doc.sh'
      - '.github/workflows/build-docs.yml'
  workflow_dispatch: {}

jobs:
  build-sleeper-agents-guide:
    name: Build Sleeper Agents Framework Guide
    runs-on: self-hosted
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      - name: Build PDF with LaTeX
        run: |
          echo "Building Sleeper Agents Framework Guide..."

          # Create output directory
          mkdir -p docs_output

          # Build PDF using texlive Docker image (run pdflatex twice for TOC)
          # Use --user to ensure artifacts are owned by runner user, not root
          docker run --rm \
            --user "$(id -u):$(id -g)" \
            -v "$(pwd)/packages/sleeper_agents/docs:/data" \
            -v "$(pwd)/docs_output:/output" \
            texlive/texlive:TL2024-historic \
            bash -c "cd /data && \
              pdflatex -interaction=nonstopmode -output-directory=/output Sleeper_Agents_Framework_Guide.tex && \
              pdflatex -interaction=nonstopmode -output-directory=/output Sleeper_Agents_Framework_Guide.tex"

          echo "PDF build completed"
          ls -la docs_output/

      - name: Verify and rename PDF
        run: |
          if [ -f docs_output/Sleeper_Agents_Framework_Guide.pdf ]; then
            echo "PDF successfully created"
            # Rename to sensible kebab-case filename
            mv docs_output/Sleeper_Agents_Framework_Guide.pdf docs_output/sleeper-agents-framework-guide.pdf
            ls -lh docs_output/sleeper-agents-framework-guide.pdf
          else
            echo "ERROR: PDF was not created"
            exit 1
          fi

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: sleeper-agents-framework-guide
          path: docs_output/sleeper-agents-framework-guide.pdf
          retention-days: 90

      - name: Cleanup build artifacts
        if: always()
        run: |
          rm -rf docs_output/*.aux docs_output/*.log docs_output/*.toc \
                 docs_output/*.out docs_output/*.fls docs_output/*.fdb_latexmk \
                 2>/dev/null || true

  build-agentcore-memory-guide:
    name: Build AgentCore Memory Integration Guide
    runs-on: self-hosted
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      - name: Build PDF with LaTeX
        run: |
          echo "Building AgentCore Memory Integration Guide..."

          # Create output directory
          mkdir -p docs_output

          # Build PDF using texlive Docker image (run pdflatex 3x for TOC and refs)
          # Use --user to ensure artifacts are owned by runner user, not root
          docker run --rm \
            --user "$(id -u):$(id -g)" \
            -v "$(pwd)/docs/integrations/ai-services:/data" \
            -v "$(pwd)/docs_output:/output" \
            texlive/texlive:TL2024-historic \
            bash -c "cd /data && \
              pdflatex -interaction=nonstopmode -output-directory=/output AgentCore_Memory_Integration_Guide.tex && \
              pdflatex -interaction=nonstopmode -output-directory=/output AgentCore_Memory_Integration_Guide.tex && \
              pdflatex -interaction=nonstopmode -output-directory=/output AgentCore_Memory_Integration_Guide.tex"

          echo "PDF build completed"
          ls -la docs_output/

      - name: Verify and rename PDF
        run: |
          if [ -f docs_output/AgentCore_Memory_Integration_Guide.pdf ]; then
            echo "PDF successfully created"
            # Rename to sensible kebab-case filename
            mv docs_output/AgentCore_Memory_Integration_Guide.pdf docs_output/agentcore-memory-integration-guide.pdf
            ls -lh docs_output/agentcore-memory-integration-guide.pdf
          else
            echo "ERROR: PDF was not created"
            exit 1
          fi

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: agentcore-memory-integration-guide
          path: docs_output/agentcore-memory-integration-guide.pdf
          retention-days: 90

      - name: Cleanup build artifacts
        if: always()
        run: |
          rm -rf docs_output/*.aux docs_output/*.log docs_output/*.toc \
                 docs_output/*.out docs_output/*.fls docs_output/*.fdb_latexmk \
                 2>/dev/null || true

  build-virtual-character-guide:
    name: Build Virtual Character System Guide
    runs-on: self-hosted
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      - name: Build PDF with LaTeX
        run: |
          echo "Building Virtual Character System Guide..."

          # Create output directory
          mkdir -p docs_output

          # Build PDF using texlive Docker image with latexmk for automatic dependency resolution
          # Use --user to ensure artifacts are owned by runner user, not root
          docker run --rm \
            --user "$(id -u):$(id -g)" \
            -v "${{ github.workspace }}/docs/integrations/ai-services:/data" \
            -v "${{ github.workspace }}/docs_output:/output" \
            texlive/texlive:TL2024-historic \
            bash -c "cd /data && latexmk -pdf -interaction=nonstopmode -output-directory=/output Virtual_Character_System_Guide.tex"

          echo "PDF build completed"
          ls -la docs_output/

      - name: Verify and rename PDF
        run: |
          if [ -f docs_output/Virtual_Character_System_Guide.pdf ]; then
            echo "PDF successfully created"
            # Rename to sensible kebab-case filename
            mv docs_output/Virtual_Character_System_Guide.pdf docs_output/virtual-character-system-guide.pdf
            ls -lh docs_output/virtual-character-system-guide.pdf
          else
            echo "ERROR: PDF was not created"
            exit 1
          fi

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: virtual-character-system-guide
          path: docs_output/virtual-character-system-guide.pdf
          retention-days: 90

      - name: Cleanup build artifacts
        if: always()
        run: |
          rm -rf docs_output/*.aux docs_output/*.log docs_output/*.toc \
                 docs_output/*.out docs_output/*.fls docs_output/*.fdb_latexmk \
                 2>/dev/null || true

  build-wmd-proliferation-report:
    name: Build AI Agents WMD Proliferation Report
    runs-on: self-hosted
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      - name: Build PDF with LaTeX
        run: ./automation/ci-cd/build-latex-doc.sh ai-agents-wmd-proliferation.tex

      - name: Rename PDF to sensible filename
        run: |
          # Rename to include -report suffix for consistency
          mv docs_output/ai-agents-wmd-proliferation.pdf docs_output/ai-agents-wmd-proliferation-report.pdf
          ls -lh docs_output/ai-agents-wmd-proliferation-report.pdf

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: ai-agents-wmd-proliferation-report
          path: docs_output/ai-agents-wmd-proliferation-report.pdf
          retention-days: 90

  build-political-targeting-report:
    name: Build AI Agents Political Targeting Report
    runs-on: self-hosted
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      - name: Build PDF with LaTeX
        run: ./automation/ci-cd/build-latex-doc.sh ai-agents-political-targeting.tex

      - name: Rename PDF to sensible filename
        run: |
          # Rename to include -report suffix for consistency
          mv docs_output/ai-agents-political-targeting.pdf docs_output/ai-agents-political-targeting-report.pdf
          ls -lh docs_output/ai-agents-political-targeting-report.pdf

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: ai-agents-political-targeting-report
          path: docs_output/ai-agents-political-targeting-report.pdf
          retention-days: 90
