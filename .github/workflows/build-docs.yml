---
name: Build Documentation

on:
  workflow_call: {}
  workflow_dispatch: {}

env:
  TEXLIVE_IMAGE: texlive-local

jobs:
  build-all-docs:
    name: Build All LaTeX Documents
    runs-on: self-hosted
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
          clean: true

      - name: Build TeXLive image
        run: |
          echo "Building TeXLive image..."
          docker build -t $TEXLIVE_IMAGE -f docker/texlive.Dockerfile .
          echo "Image built successfully"

      - name: Build all documents
        run: |
          echo "Building all LaTeX documents..."
          mkdir -p docs_output

          # Guides
          ./automation/ci-cd/build-latex-doc.sh \
            Sleeper_Agents_Framework_Guide.tex \
            packages/sleeper_agents/docs \
            docs_output \
            sleeper-agents-framework-guide

          ./automation/ci-cd/build-latex-doc.sh \
            AgentCore_Memory_Integration_Guide.tex \
            docs/integrations/ai-services \
            docs_output \
            agentcore-memory-integration-guide

          ./automation/ci-cd/build-latex-doc.sh \
            Virtual_Character_System_Guide.tex \
            docs/integrations/ai-services \
            docs_output \
            virtual-character-system-guide

          # Projection reports
          ./automation/ci-cd/build-latex-doc.sh \
            ai-agents-wmd-proliferation.tex \
            docs/projections/latex \
            docs_output \
            ai-agents-wmd-proliferation-report

          ./automation/ci-cd/build-latex-doc.sh \
            ai-agents-political-targeting.tex \
            docs/projections/latex \
            docs_output \
            ai-agents-political-targeting-report

          ./automation/ci-cd/build-latex-doc.sh \
            ai-agents-espionage-operations.tex \
            docs/projections/latex \
            docs_output \
            ai-agents-espionage-operations-report

          ./automation/ci-cd/build-latex-doc.sh \
            ai-agents-economic-actors.tex \
            docs/projections/latex \
            docs_output \
            ai-agents-economic-actors-report

          ./automation/ci-cd/build-latex-doc.sh \
            ai-agents-financial-integrity.tex \
            docs/projections/latex \
            docs_output \
            ai-agents-financial-integrity-report

          ./automation/ci-cd/build-latex-doc.sh \
            ai-agents-institutional-erosion.tex \
            docs/projections/latex \
            docs_output \
            ai-agents-institutional-erosion-report

          # Research papers
          ./automation/ci-cd/build-latex-doc.sh \
            architectural-qualia.tex \
            docs/philosophy/latex \
            docs_output

          # Hardware systems
          ./automation/ci-cd/build-latex-doc.sh \
            ai-agent-containment-infrastructure-security-framework.tex \
            docs/hardware/latex \
            docs_output \
            ai-agent-containment-infrastructure-security-framework

          ./automation/ci-cd/build-latex-doc.sh \
            bioforge-crispr-automation.tex \
            docs/hardware/latex \
            docs_output \
            bioforge-crispr-automation

          ./automation/ci-cd/build-latex-doc.sh \
            secure-terminal-briefcase.tex \
            docs/hardware/latex \
            docs_output \
            secure-terminal-briefcase

          # Handouts
          ./automation/ci-cd/build-latex-doc.sh \
            Agentic_Workflow_Handout.tex \
            docs/agents \
            docs_output \
            agentic-workflow-handout

          echo "All documents built successfully"
          ls -lh docs_output/*.pdf

      - name: Upload PDF artifacts
        uses: actions/upload-artifact@v6
        with:
          name: documentation-pdfs-${{ github.run_id }}-${{ github.run_attempt }}
          path: docs_output/*.pdf
          retention-days: 90
