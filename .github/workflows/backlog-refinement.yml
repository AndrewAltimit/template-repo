---
# Multi-Agent Backlog Refinement Pipeline
#
# Periodically reviews backlog items with multiple AI agents and
# posts unique insights as comments. Each agent provides a different
# perspective (architecture, security, implementation, maintenance).
#
# STATUS: MANUAL-ONLY - Schedule disabled until ready for production
#
# To enable:
# 1. Uncomment the schedule section
# 2. Configure agents in .agents.yaml
# 3. Ensure AGENT_TOKEN secret is set

name: Backlog Refinement Pipeline

on:
  # DISABLED: Uncomment to enable scheduled runs
  # schedule:
  #   # Twice weekly: Tuesday and Friday at 10 AM UTC
  #   - cron: '0 10 * * 2,5'

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      agents:
        description: 'Agents to use (comma-separated)'
        required: false
        type: string
        default: 'claude,gemini'
      max-issues:
        description: 'Maximum issues to review'
        required: false
        type: number
        default: 5
      max-comments:
        description: 'Maximum comments per issue'
        required: false
        type: number
        default: 2
      min-age-days:
        description: 'Minimum issue age (days)'
        required: false
        type: number
        default: 3
      dry-run:
        description: 'Dry run (review but do not post comments)'
        required: false
        type: boolean
        default: true
      enable-issue-management:
        description: 'Allow agents to manage issues (close, update, label) based on maintainer feedback'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  issues: write

concurrency:
  group: backlog-refinement
  cancel-in-progress: false

jobs:
  refine:
    name: Refine Backlog
    runs-on: self-hosted
    timeout-minutes: 30

    outputs:
      issues-reviewed: ${{ steps.refine.outputs.issues_reviewed }}
      insights-added: ${{ steps.refine.outputs.insights_added }}
      summary-json: ${{ steps.refine.outputs.summary_json }}

    steps:
      # Fix Docker-created directory permissions BEFORE checkout
      # Previous runs may have created files as root which blocks checkout cleanup
      # NOTE: Uses Docker (not sudo) to fix permissions - avoids password prompt hangs
      - name: Fix Docker directory permissions (pre-checkout)
        run: |
          echo "::group::Pre-Checkout: Fix Docker Directory Permissions"
          WORKSPACE="${GITHUB_WORKSPACE:-$(pwd)}"

          # List of directories that Docker may have created with root ownership
          # Using direct paths instead of 'find' to avoid hangs on permission-denied dirs
          DIRS_TO_FIX=(
            "outputs"
            "evaluation_results"
            ".agent-venv"
            "__pycache__"
            ".pytest_cache"
          )

          # Fix permissions using Docker (runs as root, no sudo password needed)
          for dir in "${DIRS_TO_FIX[@]}"; do
            # Skip symlinks to prevent chown on unintended paths
            if [ -L "$WORKSPACE/$dir" ]; then
              echo "  Skipping symlink: $WORKSPACE/$dir"
              continue
            fi
            if [ -d "$WORKSPACE/$dir" ]; then
              echo "Fixing ownership via Docker: $WORKSPACE/$dir"
              # Use busybox to chown the directory to the current user
              # -Rh: recursive, affect symlinks themselves (not targets)
              # Use timeout if available to prevent hangs, fall back to direct call
              if command -v timeout &> /dev/null; then
                timeout 30 docker run --rm \
                  -v "$WORKSPACE/$dir:/target" \
                  busybox:1.36.1 \
                  chown -Rh "$(id -u):$(id -g)" /target 2>/dev/null || echo "  Warning: Could not fix $dir (may already have correct ownership)"
              else
                docker run --rm \
                  -v "$WORKSPACE/$dir:/target" \
                  busybox:1.36.1 \
                  chown -Rh "$(id -u):$(id -g)" /target 2>/dev/null || echo "  Warning: Could not fix $dir (may already have correct ownership)"
              fi
            fi
          done

          echo "Permissions check complete"
          echo "::endgroup::"

      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Rust binaries
        run: |
          echo "::group::Setup Rust Binaries"

          # Check if github-agents binary exists
          GITHUB_AGENTS="${GITHUB_WORKSPACE}/tools/rust/github-agents-cli/target/release/github-agents"
          if [ -x "$GITHUB_AGENTS" ]; then
            echo "github-agents found at $GITHUB_AGENTS"
          else
            echo "Building github-agents from source..."
            cd "${GITHUB_WORKSPACE}/tools/rust/github-agents-cli"
            cargo build --release
          fi

          # Create symlink for easy access
          mkdir -p "$HOME/.local/bin"
          ln -sf "${GITHUB_WORKSPACE}/tools/rust/github-agents-cli/target/release/github-agents" "$HOME/.local/bin/github-agents"
          echo "PATH=$HOME/.local/bin:$PATH" >> $GITHUB_ENV

          echo "::endgroup::"

      - name: Load configuration
        id: config
        run: |
          echo "::group::Load Configuration"

          AGENTS="${{ inputs.agents || 'claude,gemini' }}"
          MAX_ISSUES="${{ inputs.max-issues || '5' }}"
          MAX_COMMENTS="${{ inputs.max-comments || '2' }}"
          MIN_AGE="${{ inputs.min-age-days || '3' }}"
          # Handle boolean properly: false || 'true' would incorrectly give 'true'
          DRY_RUN="${{ inputs.dry-run == false && 'false' || 'true' }}"
          ENABLE_ISSUE_MGMT="${{ inputs.enable-issue-management == true && 'true' || 'false' }}"

          echo "agents=$AGENTS" >> $GITHUB_OUTPUT
          echo "max_issues=$MAX_ISSUES" >> $GITHUB_OUTPUT
          echo "max_comments=$MAX_COMMENTS" >> $GITHUB_OUTPUT
          echo "min_age=$MIN_AGE" >> $GITHUB_OUTPUT
          echo "dry_run=$DRY_RUN" >> $GITHUB_OUTPUT
          echo "enable_issue_mgmt=$ENABLE_ISSUE_MGMT" >> $GITHUB_OUTPUT

          echo "Configuration:"
          echo "  Agents: $AGENTS"
          echo "  Max Issues: $MAX_ISSUES"
          echo "  Max Comments/Issue: $MAX_COMMENTS"
          echo "  Min Age Days: $MIN_AGE"
          echo "  Dry Run: $DRY_RUN"
          echo "  Issue Management: $ENABLE_ISSUE_MGMT"

          echo "::endgroup::"

      - name: Run backlog refinement
        id: refine
        env:
          GITHUB_TOKEN: ${{ secrets.AGENT_TOKEN }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          AGENTS: ${{ steps.config.outputs.agents }}
          MAX_ISSUES: ${{ steps.config.outputs.max_issues }}
          MAX_COMMENTS: ${{ steps.config.outputs.max_comments }}
          MIN_AGE: ${{ steps.config.outputs.min_age }}
          DRY_RUN: ${{ steps.config.outputs.dry_run }}
        run: |
          echo "::group::Backlog Refinement"

          # Build command args
          CMD_ARGS="--agents $AGENTS --max-issues $MAX_ISSUES --max-comments $MAX_COMMENTS --min-age-days $MIN_AGE --format json"

          if [ "$DRY_RUN" = "true" ]; then
            CMD_ARGS="$CMD_ARGS --dry-run"
          fi

          echo "Running: github-agents refinement-monitor $CMD_ARGS"

          # Run Rust CLI and capture JSON output (separate stderr to avoid polluting JSON)
          # This prevents warnings like "Building github-agents" from breaking jq parsing
          STDERR_LOG=$(mktemp)
          REFINEMENT_OUTPUT=$(github-agents refinement-monitor $CMD_ARGS 2>"$STDERR_LOG") || {
            echo "Refinement command failed. Stderr:"
            cat "$STDERR_LOG"
            REFINEMENT_OUTPUT='[]'
          }
          rm -f "$STDERR_LOG"

          echo "Refinement output: $REFINEMENT_OUTPUT"

          # Parse JSON output
          ISSUES_REVIEWED=$(echo "$REFINEMENT_OUTPUT" | jq 'length // 0' 2>/dev/null || echo "0")
          INSIGHTS_ADDED=$(echo "$REFINEMENT_OUTPUT" | jq '[.[].insights_added] | add // 0' 2>/dev/null || echo "0")

          echo "issues_reviewed=$ISSUES_REVIEWED" >> $GITHUB_OUTPUT
          echo "insights_added=$INSIGHTS_ADDED" >> $GITHUB_OUTPUT
          echo "actions_taken=0" >> $GITHUB_OUTPUT
          # Use heredoc for multiline JSON to avoid GITHUB_OUTPUT parsing issues
          {
            echo 'summary_json<<EOF'
            echo "$REFINEMENT_OUTPUT"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

          echo "::endgroup::"

      - name: Generate summary
        if: always()
        env:
          ISSUES_REVIEWED: ${{ steps.refine.outputs.issues_reviewed }}
          INSIGHTS_ADDED: ${{ steps.refine.outputs.insights_added }}
          ACTIONS_TAKEN: ${{ steps.refine.outputs.actions_taken }}
          DRY_RUN: ${{ steps.config.outputs.dry_run }}
          ISSUE_MGMT: ${{ steps.config.outputs.enable_issue_mgmt }}
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Backlog Refinement Results

          | Metric | Value |
          |--------|-------|
          | Issues Reviewed | ${ISSUES_REVIEWED:-0} |
          | Insights Added | ${INSIGHTS_ADDED:-0} |
          | Actions Taken | ${ACTIONS_TAKEN:-0} |
          | Dry Run | ${DRY_RUN:-true} |
          | Issue Management | ${ISSUE_MGMT:-false} |

          ### Configuration
          - **Agents**: ${{ steps.config.outputs.agents }}
          - **Max Issues**: ${{ steps.config.outputs.max_issues }}
          - **Max Comments/Issue**: ${{ steps.config.outputs.max_comments }}
          - **Min Issue Age**: ${{ steps.config.outputs.min_age }} days
          - **Issue Management**: ${{ steps.config.outputs.enable_issue_mgmt }}

          ### Agent Perspectives
          | Agent | Focus Area |
          |-------|------------|
          | Claude | Architecture & Design |
          | Gemini | Quality & Security |
          | Codex | Implementation |
          | OpenCode | Maintenance |

          ---
          *Run: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOF

  weekly-summary:
    name: Weekly Summary
    needs: refine
    runs-on: self-hosted
    # Only on Friday runs
    if: github.event_name == 'schedule' && contains(github.event.schedule, '* * 5')

    steps:
      - name: Generate weekly report
        run: |
          echo "## Weekly Backlog Refinement Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This week's refinement activity:" >> $GITHUB_STEP_SUMMARY
          echo "- Issues reviewed: ${{ needs.refine.outputs.issues-reviewed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Insights added: ${{ needs.refine.outputs.insights-added }}" >> $GITHUB_STEP_SUMMARY
