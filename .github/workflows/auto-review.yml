name: Auto Review

on:
  workflow_dispatch:
    inputs:
      agents:
        description: 'AI agents to use (comma-separated: claude,gemini,opencode,crush)'
        required: false
        type: string
        default: 'claude,gemini'
      target:
        description: 'What to review'
        required: true
        type: choice
        options:
          - issues
          - pull-requests
          - both
        default: 'both'
      issue_numbers:
        description: 'Specific issue numbers to review (comma-separated, optional)'
        required: false
        type: string
      pr_numbers:
        description: 'Specific PR numbers to review (comma-separated, optional)'
        required: false
        type: string
      review_depth:
        description: 'Review depth'
        required: true
        type: choice
        options:
          - quick    # Basic review, main points only
          - standard # Normal review with suggestions
          - thorough # Deep analysis with detailed feedback
        default: 'standard'
      comment_style:
        description: 'Comment style'
        required: true
        type: choice
        options:
          - consolidated # One comment per agent with all findings
          - inline       # Multiple inline comments where relevant
          - summary      # Single summary comment combining all agents
        default: 'consolidated'

permissions:
  issues: write
  pull-requests: write
  contents: read

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  # Enable BuildKit for docker compose builds (required for --mount syntax in Dockerfiles)
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  auto-review:
    name: Auto Review with AI Agents
    runs-on: self-hosted
    if: |
      vars.ENABLE_AGENTS == 'true' && (
        github.event_name == 'workflow_dispatch' ||
        github.event_name == 'schedule'
      )

    steps:
      - name: Log Review Configuration
        run: |
          echo "=== Auto Review Configuration ==="
          echo "Event: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "Mode: READ-ONLY REVIEW (no approvals needed)"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Agents: ${{ inputs.agents }}"
            echo "Target: ${{ inputs.target }}"
            echo "Issue Numbers: ${{ inputs.issue_numbers || 'all open' }}"
            echo "PR Numbers: ${{ inputs.pr_numbers || 'all open' }}"
            echo "Review Depth: ${{ inputs.review_depth }}"
            echo "Comment Style: ${{ inputs.comment_style }}"
          else
            echo "Running scheduled review with default settings"
            echo "This will review ALL open issues and PRs without requiring approval keywords"
          fi
          echo "==============================="

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.AGENT_TOKEN }}

      - name: Configure Git (read-only mode)
        run: |
          # Set git identity for the AI agent (even though we won't commit)
          git config --global user.name "AI Review Agent"
          git config --global user.email "ai-review@localhost"

          # Ensure we're in a safe read-only state
          git config --global core.fileMode false

      - name: Set up Rust binaries
        run: |
          echo "[INFO] Setting up Rust CLI binaries..."

          # Check if github-agents binary exists
          GITHUB_AGENTS="${GITHUB_WORKSPACE}/tools/rust/github-agents-cli/target/release/github-agents"
          if [ -x "$GITHUB_AGENTS" ]; then
            echo "github-agents found at $GITHUB_AGENTS"
          else
            echo "Building github-agents from source..."
            cd "${GITHUB_WORKSPACE}/tools/rust/github-agents-cli"
            cargo build --release
          fi

          # Create symlinks for easy access
          mkdir -p "$HOME/.local/bin"
          ln -sf "${GITHUB_WORKSPACE}/tools/rust/github-agents-cli/target/release/github-agents" "$HOME/.local/bin/github-agents"
          ln -sf "${GITHUB_WORKSPACE}/tools/rust/board-manager/target/release/board-manager" "$HOME/.local/bin/board-manager" 2>/dev/null || true
          echo "PATH=$HOME/.local/bin:$PATH" >> $GITHUB_ENV

          # Install agent requirements if needed
          echo "[INFO] Installing additional requirements..."
          python3 -m pip install --user -r docker/requirements/requirements-agents.txt 2>/dev/null || true

      - name: Build Docker containers for containerized agents
        if: contains(inputs.agents, 'opencode') || contains(inputs.agents, 'crush') || github.event_name == 'schedule'
        run: |
          echo "[INFO] Building containers for OpenRouter agents..."
          docker compose --profile agents build openrouter-agents
          echo "[INFO] Container build complete"

      - name: Set up Node.js for Claude (if needed)
        if: contains(inputs.agents, 'claude') || github.event_name == 'schedule'
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          if command -v nvm &> /dev/null; then
            echo "[INFO] Setting Node.js version for Claude..."
            nvm use 22.16.0 || {
              echo "[WARNING] Node.js 22.16.0 not found, trying to install..."
              nvm install 22.16.0
              nvm use 22.16.0
            }
            echo "[INFO] Node.js version: $(node --version)"
          fi

      - name: Run Auto Review
        env:
          GITHUB_TOKEN: ${{ secrets.AGENT_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ENABLE_AGENTS: ${{ vars.ENABLE_AGENTS }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          REVIEW_TARGET: ${{ inputs.target || 'both' }}
        run: |
          echo "=== Starting Auto Review ==="
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Target: $REVIEW_TARGET"

          # Find the github-agents binary
          GITHUB_AGENTS=""
          for path in \
            "./tools/rust/github-agents-cli/target/release/github-agents" \
            "$HOME/.local/bin/github-agents"; do
            if [ -x "$path" ]; then
              GITHUB_AGENTS="$path"
              break
            fi
          done

          # Fall back to PATH lookup
          if [ -z "$GITHUB_AGENTS" ]; then
            GITHUB_AGENTS=$(command -v github-agents 2>/dev/null || true)
          fi

          if [ -z "$GITHUB_AGENTS" ]; then
            echo "[ERROR] github-agents binary not found. Build with:"
            echo "  cd tools/rust/github-agents-cli && cargo build --release"
            exit 1
          fi

          echo "Using: $GITHUB_AGENTS"
          SUCCESS=true

          # Process issues if requested
          if [ "$REVIEW_TARGET" = "issues" ] || [ "$REVIEW_TARGET" = "both" ]; then
            echo "Processing issues..."
            "$GITHUB_AGENTS" issue-monitor || SUCCESS=false
          fi

          # Process PRs if requested
          if [ "$REVIEW_TARGET" = "pull-requests" ] || [ "$REVIEW_TARGET" = "both" ]; then
            echo "Processing PRs..."
            "$GITHUB_AGENTS" pr-monitor || SUCCESS=false
          fi

          if [ "$SUCCESS" = "false" ]; then
            echo "[ERROR] Auto review completed with failures"
            exit 1
          fi
          echo "Auto review completed successfully"

      - name: Summary
        if: always()
        run: |
          echo "=== Auto Review Summary ==="
          echo "Completion time: $(date)"
          echo "Workflow status: ${{ job.status }}"
          if [ "${{ job.status }}" = "failure" ]; then
            echo "[ERROR] Auto review failed - check logs above for details"
          else
            echo "[SUCCESS] Auto review completed successfully"
          fi
          echo "=========================="
