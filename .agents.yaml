# Multi-Agent System Configuration
# This file configures the AI agents available for automated CI/CD tasks
#
# IMPORTANT: All agents run in AUTONOMOUS MODE for CI/CD automation
# - Agents must run without human interaction
# - All agents operate in sandboxed environments (containers/VMs)
# - Interactive prompts are disabled (e.g., --dangerously-skip-permissions)

# List of enabled agents
# NOTE: Some agents are only available in specific environments:
# - Host-only agents: claude (needs subscription auth), gemini (needs Docker access)
# - Container-only agents: opencode, crush (installed in openrouter-agents container)
enabled_agents:
  - claude      # Anthropic's Claude Code (host-only, primary agent)
  - gemini      # Google's Gemini CLI (host-only, for reviews)
  # Containerized agents (automatically run in Docker when invoked)
  - opencode    # Open-source alternative (runs in container)
  - crush       # Charm Bracelet's multi-provider tool (runs in container)

# Agent priorities for different task types
agent_priorities:
  # For creating PRs from issues
  issue_creation:
    - claude      # Best for implementation

  # For reviewing PRs
  pr_reviews:
    - gemini      # Excellent for code review
    - claude      # Fallback option

  # For implementing code fixes
  code_fixes:
    - claude      # Most capable for fixes

# Security settings
security:
  # Users authorized to trigger agent actions via [Approved][Agent] keywords
  # CRITICAL: Only add trusted human users - these can execute code via agents
  # Agent admins can also use [CONTINUE] in PR comments to extend iteration limits
  agent_admins:
    - AndrewAltimit           # Repository owner

  # Trusted sources for comment context (used in PR reviews)
  # Comments from these accounts are marked as trusted when providing context to AI
  # This does NOT grant them ability to trigger agent actions
  trusted_sources:
    - AndrewAltimit           # Repository owner
    - github-actions[bot]     # GitHub Actions bot
    - dependabot[bot]         # Dependabot
    - renovate[bot]           # Renovate bot

  # Autonomous mode is REQUIRED for CI/CD operation
  # All agents run in sandboxed environments for security
  autonomous_mode: true  # Enables non-interactive flags like --dangerously-skip-permissions

  # Confirm running in sandboxed environment
  require_sandbox: true

  # Maximum prompt length to prevent abuse
  max_prompt_length: 10000

  # Cleanup temporary files after use
  temp_file_cleanup: true

  # Maximum execution time per agent call
  subprocess_timeout: 600  # 10 minutes

  # Memory limit for subprocess execution
  memory_limit_mb: 500

# Rate limiting (per agent)
rate_limits:
  requests_per_minute: 10
  requests_per_hour: 100

  # Agent-specific overrides
  claude:
    requests_per_minute: 20  # Claude can handle more
  gemini:
    requests_per_minute: 5   # More conservative for Gemini

# Model configuration overrides
model_overrides:
  # Gemini models
  # Using explicit model specification with API key authentication
  # Model names verified from gemini-config.json
  gemini:
    pro_model: gemini-3-pro-preview  # Latest preview model (NOT 3.0!)
    flash_model: gemini-3-flash-preview  # Fast fallback model (Gemini 3 Flash)
    default_model: gemini-3-flash-preview  # Primary model for PR reviews (faster, lower rate limits)

  # OpenRouter agents configuration
  opencode:
    model: qwen/qwen-2.5-coder-32b-instruct
    temperature: 0.2

  crush:
    model: qwen/qwen-2.5-coder-32b-instruct
    temperature: 0.1  # Lower temperature for Crush

# OpenRouter configuration (for future agents)
openrouter:
  # API key must be provided as OPENROUTER_API_KEY environment variable

  # Default model for OpenRouter-compatible agents
  default_model: qwen/qwen-2.5-coder-32b-instruct

  # Fallback models if primary is unavailable
  fallback_models:
    - deepseek/deepseek-coder-v2-instruct
    - meta-llama/llama-3.1-70b-instruct

# PR Review configuration
pr_review:
  # Default agent for reviews (from enabled_agents)
  default_agent: gemini

  # Review constraints
  max_words: 500
  condensation_threshold: 600

  # Incremental review settings
  incremental_enabled: true

  # Trust bucketing (uses security.agent_admins and security.trusted_sources)
  include_comment_context: true

  # Hallucination detection
  verify_claims: true

  # Reaction images config
  reaction_config_url: "https://raw.githubusercontent.com/AndrewAltimit/Media/refs/heads/main/reaction/config.yaml"

# Automation settings for inline agent feedback loop
automation:
  # Enable inline agent feedback loop in PR validation
  inline_feedback_loop: true

  # Maximum iterations before stopping (prevents infinite loops)
  max_auto_fix_iterations: 5

  # Try autoformat (black, isort) before invoking AI
  autoformat_first: true

  # Categories of failures to auto-fix
  # Options: formatting, linting, type_errors, unused_imports, test_failures
  auto_fix_categories:
    - formatting
    - linting
    - type_errors
    - unused_imports

  # Skip auto-fix for PRs with these labels
  skip_labels:
    - no-auto-fix
    - needs-human-review

# Advanced settings
advanced:
  # Enable debug logging
  debug_mode: false

  # Custom paths
  # Set AGENT_TEMP_DIR environment variable to override
  temp_directory: /tmp/agents

  # Retry configuration
  max_retries: 2
  retry_delay_seconds: 5

  # Subprocess environment isolation
  isolate_environment: true

  # Enable telemetry (metrics collection)
  enable_telemetry: false

  # Non-interactive mode settings
  non_interactive_flags:
    claude: ["--print", "--dangerously-skip-permissions"]
    # For gemini: Use -p for prompt and -m for model selection (both work reliably with API keys)
    # Note: Only -p is passed by default; model selection uses .env configuration (GEMINI_PRIMARY_MODEL)
    gemini: ["-p"]
    opencode: ["--non-interactive"]
    crush: ["--non-interactive", "--no-update"]
